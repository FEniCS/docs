
<!DOCTYPE html>

<html class="writer-html5" data-content_root="../" lang="en">
<head>
<meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Electromagnetic scattering from a sphere (axisymmetric) — DOLFINx 0.10.0.post0 documentation</title>
<link href="../_static/pygments.css?v=03e43079" rel="stylesheet" type="text/css"/>
<link href="../_static/css/theme.css?v=e59714d7" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-codeautolink.css?v=b2176991" rel="stylesheet" type="text/css"/>
<script src="../_static/jquery.js?v=5d32c60e"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
<script src="../_static/documentation_options.js?v=d1f39eef"></script>
<script src="../_static/doctools.js?v=9bcbadda"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="../_static/js/theme.js"></script>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="demo_mixed-poisson.html" rel="next" title="Mixed formulation of the Poisson equation with a block-preconditioner/solver # noqa"/>
<link href="demo_half_loaded_waveguide.html" rel="prev" title="Electromagnetic modal analysis for a waveguide"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../index.html">
            DOLFINx
          </a>
<div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../demos.html">Demos</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../demos.html#pdes-introductory">PDEs (introductory)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_poisson.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_helmholtz.html">Helmholtz equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_scattering_boundary_conditions.html">Electromagnetic scattering from a wire with scattering BCs</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html">Electromagnetic scattering from a wire with PML</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html#mesh-generation-with-gmsh">Mesh generation with GMSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_half_loaded_waveguide.html">Electromagnetic modal analysis for a waveguide</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Electromagnetic scattering from a sphere (axisymmetric)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#equations-problem-definition-and-implementation">Equations, problem definition and implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#problem-formulation">Problem formulation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#pdes-advanced">PDEs (advanced)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#nonlinear-problems">Nonlinear problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#mesh-generation">Mesh generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#interpolation-io-and-visualisation">Interpolation, IO and visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#advanced-iterative-solvers">Advanced iterative solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#user-defined-and-advanced-finite-elements">User-defined and advanced finite elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#parallel-communication-analysis">Parallel communication analysis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../demos.html#list-of-all-demos">List of all demos</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_poisson.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_biharmonic.html">Biharmonic equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_cahn-hilliard.html">Cahn-Hilliard equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_stokes.html">Stokes equations using Taylor-Hood elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_elasticity.html">Elasticity using algebraic multigrid</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_gmsh.html">Mesh generation with Gmsh</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_helmholtz.html">Helmholtz equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_static-condensation.html">Static condensation of linear elasticity</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pyvista.html">Visualization with PyVista</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_interpolation-io.html">Interpolation and IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_types.html">Solving PDEs with different scalar (float) types</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_lagrange_variants.html">Variants of Lagrange elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_tnt-elements.html">Creating TNT elements using Basix’s custom element interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_scattering_boundary_conditions.html">Electromagnetic scattering from a wire with scattering BCs</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html">Electromagnetic scattering from a wire with PML</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html#mesh-generation-with-gmsh">Mesh generation with GMSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_half_loaded_waveguide.html">Electromagnetic modal analysis for a waveguide</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Electromagnetic scattering from a sphere (axisymmetric)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#equations-problem-definition-and-implementation">Equations, problem definition and implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#problem-formulation">Problem formulation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="demo_navier-stokes.html">Divergence conforming discontinuous Galerkin method for the Navier–Stokes equations # noqa</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-poisson.html">Mixed formulation of the Poisson equation with a block-preconditioner/solver # noqa</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pyamg.html">Solve the Poisson and linearised elasticity equations using pyamg</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_hdg.html">HDG scheme for the Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-topology.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_comm-pattern.html">Parallel communication pattern analysis</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../index.html">DOLFINx</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="Page navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Home" class="icon icon-home" href="../index.html"></a></li>
<li class="breadcrumb-item"><a href="../demos.html">Demos</a></li>
<li class="breadcrumb-item active">Electromagnetic scattering from a sphere (axisymmetric)</li>
<li class="wy-breadcrumbs-aside">
<a href="../_sources/demos/demo_axis.md.txt" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<section class="tex2jax_ignore mathjax_ignore" id="electromagnetic-scattering-from-a-sphere-axisymmetric">
<h1>Electromagnetic scattering from a sphere (axisymmetric)<a class="headerlink" href="#electromagnetic-scattering-from-a-sphere-axisymmetric" title="Link to this heading"></a></h1>
<p>Copyright (C) 2022 Michele Castriotta, Igor Baratta, Jørgen S. Dokken</p>
<div class="download admonition">
<p class="admonition-title">Download sources</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../_downloads/1a16c2f4b29ea3e52acc5e0c69e7d325/demo_axis.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="../_downloads/5261c2fbfdb83b277c92e92bde061504/demo_axis.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span></code></a></p></li>
</ul>
</div>
<p>This demo illustrates how to:</p>
<ul class="simple">
<li><p>Setup and solve Maxwell’s equations for axisymmetric geometries</p></li>
<li><p>Implement (axisymmetric) perfectly matched layers</p></li>
</ul>
<section id="equations-problem-definition-and-implementation">
<h2>Equations, problem definition and implementation<a class="headerlink" href="#equations-problem-definition-and-implementation" title="Link to this heading"></a></h2>
<p>Import the modules that will be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ffcx/v0.10.0/_autogenerated/ffcx.options.html#ffcx.options.Path" title="pathlib.Path"><span class="n">Path</span></a>

<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/mpi4py.html#module-mpi4py" title="mpi4py"><span class="nn">mpi4py</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.html#module-mpi4py.MPI" title="mpi4py.MPI"><span class="n">MPI</span></a>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.html#module-petsc4py" title="petsc4py"><span class="nn">petsc4py</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.html#module-petsc4py.PETSc" title="petsc4py.PETSc"><span class="n">PETSc</span></a>

<span class="kn">import</span><span class="w"> </span><span class="nn">gmsh</span>
<span class="kn">import</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/index.html#module-numpy" title="numpy"><span class="nn">numpy</span></a><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">jv</span><span class="p">,</span> <span class="n">jvp</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dolfinx</span>
<span class="kn">import</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#module-ufl" title="ufl"><span class="nn">ufl</span></a>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#module-basix.ufl" title="basix.ufl"><span class="nn">basix.ufl</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#basix.ufl.element" title="basix.ufl.element"><span class="n">element</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#basix.ufl.mixed_element" title="basix.ufl.mixed_element"><span class="n">mixed_element</span></a>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx</span><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#module-dolfinx.fem" title="dolfinx.fem"><span class="n">fem</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#module-dolfinx.io" title="dolfinx.io"><span class="n">io</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#module-dolfinx.mesh" title="dolfinx.mesh"><span class="n">mesh</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.plot.html#module-dolfinx.plot" title="dolfinx.plot"><span class="n">plot</span></a>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#module-dolfinx.fem.petsc" title="dolfinx.fem.petsc"><span class="nn">dolfinx.fem.petsc</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.LinearProblem" title="dolfinx.fem.petsc.LinearProblem"><span class="n">LinearProblem</span></a>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#module-dolfinx.io" title="dolfinx.io"><span class="nn">dolfinx.io</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#dolfinx.io.VTXWriter" title="dolfinx.io.utils.VTXWriter"><span class="n">VTXWriter</span></a>

    <span class="n">has_vtx</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"VTXWriter not available, solution will not be saved."</span><span class="p">)</span>
    <span class="n">has_vtx</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pyvista</span>

    <span class="n">have_pyvista</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"pyvista and pyvistaqt are required to visualise the solution"</span><span class="p">)</span>
    <span class="n">have_pyvista</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># The time-harmonic Maxwell equation is complex-valued. PETSc must</span>
<span class="c1"># therefore have been compiled with complex scalars.</span>
<span class="k">if</span> <span class="ow">not</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.issubdtype.html#numpy.issubdtype" title="numpy.issubdtype"><span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.complexfloating" title="numpy.complexfloating"><span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span></a><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Demo can only be executed when PETSc using complex scalars."</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_mesh_sphere_axis</span><span class="p">(</span>
    <span class="n">radius_sph</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">radius_scatt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">radius_dom</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">radius_pml</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">in_sph_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">on_sph_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">scatt_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">pml_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">au_tag</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">bkg_tag</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pml_tag</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">scatt_tag</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"geometry"</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCircle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius_sph</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">angle1</span><span class="o">=-</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">angle2</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCircle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius_sph</span><span class="p">,</span> <span class="n">angle1</span><span class="o">=-</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">angle2</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCircle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius_scatt</span><span class="p">,</span> <span class="n">angle1</span><span class="o">=-</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">angle2</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCircle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">,</span> <span class="n">angle1</span><span class="o">=-</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">angle2</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCircle</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radius_dom</span> <span class="o">+</span> <span class="n">radius_pml</span><span class="p">,</span> <span class="n">angle1</span><span class="o">=-</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">angle2</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">5</span>
    <span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">5</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">au_tag</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">bkg_tag</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">pml_tag</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">scatt_tag</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">in_sph_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">in_sph_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">on_sph_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">on_sph_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">scatt_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">scatt_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">pml_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">pml_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">pml_size</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">pml_size</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span>
</pre></div>
</div>
</section>
<section id="problem-formulation">
<h2>Problem formulation<a class="headerlink" href="#problem-formulation" title="Link to this heading"></a></h2>
<p>Consider a metallic sphere embedded in a background medium (e.g., a
vacuum or water) subject to an incident plane wave, with the objective
to calculate the scattered electric field. We can simplify the problem
by considering the axisymmetric case. To verify this, let’s consider
the weak form of the problem with PML:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\int_{\Omega_m\cup\Omega_b}-(\nabla \times \mathbf{E}_s)
\cdot (\nabla \times \bar{\mathbf{v}})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}_s \cdot \bar{\mathbf{v}}+k_{0}^{2}\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}_b \cdot \bar{\mathbf{v}}~\mathrm{d} x\\
+\int_{\Omega_{pml}}\left[\boldsymbol{\mu}^{-1}_{pml} \nabla \times
\mathbf{E}_s \right]\cdot \nabla \times \bar{\mathbf{v}}-k_{0}^{2}
\left[\boldsymbol{\varepsilon}_{pml} \mathbf{E}_s \right]\cdot
\bar{\mathbf{v}}~ d x=0
\end{split}
\end{split}\]</div>
<p>Since we want to exploit axisymmetry of the problem, we can use
cylindrical coordinates as a more appropriate reference system:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\int_{\Omega_{cs}}\int_{0}^{2\pi}-(\nabla \times \mathbf{E}_s)
\cdot (\nabla \times \bar{\mathbf{v}})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}_s \cdot \bar{\mathbf{v}}+k_{0}^{2}\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}_b \cdot
\bar{\mathbf{v}}~ \rho d\rho dz d \phi\\
+\int_{\Omega_{cs}}
\int_{0}^{2\pi}\left[\boldsymbol{\mu}^{-1}_{pml} \nabla \times
\mathbf{E}_s \right]\cdot \nabla \times \bar{\mathbf{v}}-k_{0}^{2}
\left[\boldsymbol{\varepsilon}_{pml} \mathbf{E}_s \right]\cdot
\bar{\mathbf{v}}~ \rho d\rho dz d \phi=0
\end{split}
\end{split}\]</div>
<p>Expanding <span class="math notranslate nohighlight">\(\mathbf{E}_s\)</span>, <span class="math notranslate nohighlight">\(\mathbf{E}_b\)</span> and <span class="math notranslate nohighlight">\(\bar{\mathbf{v}}\)</span> in
cylindrical harmonics:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
\mathbf{E}_s(\rho, z, \phi) &amp;= \sum_m\mathbf{E}^{(m)}_s(\rho, z)
  e^{-jm\phi} \\
\mathbf{E}_b(\rho, z, \phi) &amp;= \sum_m\mathbf{E}^{(m)}_b(\rho, z)
  e^{-jm\phi} \\
\bar{\mathbf{v}}(\rho, z, \phi) &amp;=
\sum_m\bar{\mathbf{v}}^{(m)}(\rho, z)e^{+jm\phi}
\end{align}
\end{split}\]</div>
<p>The curl operator <span class="math notranslate nohighlight">\(\nabla\times\)</span> in cylindrical coordinates becomes:</p>
<div class="math notranslate nohighlight">
\[
\nabla \times \mathbf{a}=
\sum_{m}\left(\nabla \times \mathbf{a}^{(m)}\right) e^{-j m \phi}
\]</div>
<p>with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\left(\nabla \times \mathbf{a}^{(m)}\right) = \left[\hat{\rho}
\left(-\frac{\partial a_{\phi}^{(m)}}{\partial z}
-j\frac{m}{\rho} a_{z}^{(m)}\right)+\\ \hat{\phi}
\left(\frac{\partial a_{\rho}^{(m)}}{\partial z}
-\frac{\partial a_{z}^{(m)}}{\partial \rho}\right) \right.\\
\left.+\hat{z}\left(\frac{a_{\phi}^{(m)}}{\rho}
+\frac{\partial a_{\phi}^{(m)}}{\partial \rho}
+j \frac{m}{\rho} a_{\rho}^{(m)}\right)\right]
\end{split}
\end{split}\]</div>
<p>Assuming an axisymmetric permittivity <span class="math notranslate nohighlight">\(\varepsilon(\rho, z)\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\sum_{n, m}\int_{\Omega_{cs}} -(\nabla \times \mathbf{E}^{(m)}_s)
\cdot (\nabla \times \bar{\mathbf{v}}^{(m)})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}^{(m)}_s \cdot \bar{\mathbf{v}}^{(m)}+k_{0}^{2}
\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}^{(m)}_b \cdot \bar{\mathbf{v}}^{(m)}\\
+\left(\boldsymbol{\mu}^{-1}_{pml} \nabla \times \mathbf{E}^{(m)}_s
\right)\cdot \nabla \times \bar{\mathbf{v}}^{(m)}-k_{0}^{2}
\left(\boldsymbol{\varepsilon}_{pml} \mathbf{E}^{(m)}_s \right)\cdot
\bar{\mathbf{v}}^{(m)}~ \rho d\rho dz \int_{0}^{2 \pi} e^{-i(m-n) \phi}
d \phi=0
\end{split}\]</div>
<p>For the last integral, we have that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\int_{0}^{2 \pi} e^{-i(m-n) \phi}d \phi=
\begin{cases}
2\pi &amp;\textrm{if } m=n\\
0    &amp;\textrm{if }m\neq n
\end{cases}
\end{split}\]</div>
<p>We can therefore consider only the case <span class="math notranslate nohighlight">\(m = n\)</span> and simplify the
summation in the following way:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\sum_{m}\int_{\Omega_{cs}}-(\nabla \times \mathbf{E}^{(m)}_s)
\cdot (\nabla \times \bar{\mathbf{v}}^{(m)})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}^{(m)}_s \cdot \bar{\mathbf{v}}^{(m)}
+k_{0}^{2}\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}^{(m)}_b \cdot \bar{\mathbf{v}}^{(m)}\\
+\left(\boldsymbol{\mu}^{-1}_{pml} \nabla \times \mathbf{E}^{(m)}_s
\right)\cdot \nabla \times \bar{\mathbf{v}}^{(m)}-k_{0}^{2}
\left(\boldsymbol{\varepsilon}_{pml} \mathbf{E}^{(m)}_s \right)\cdot
\bar{\mathbf{v}}^{(m)}~ \rho d\rho dz =0
\end{split}
\end{split}\]</div>
<p>What we have just obtained are multiple weak forms corresponding to
different cylindrical harmonics propagating independently. Let’s now
solve it in DOLFINx. As a first step we can define the function for
the <span class="math notranslate nohighlight">\(\nabla\times\)</span> operator in cylindrical coordinates:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">curl_axis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">curl_r</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">curl_z</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">curl_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.as_vector" title="ufl.as_vector"><span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span></a><span class="p">((</span><span class="n">curl_r</span><span class="p">,</span> <span class="n">curl_z</span><span class="p">,</span> <span class="n">curl_p</span><span class="p">))</span>
</pre></div>
</div>
<p>Then we need to define the analytical formula for the background
field. We will consider a TMz polarized plane wave, that is a plane
wave with the magnetic field normal to our reference plane</p>
<p>For a TMz polarization, we can write the cylindrical harmonics
<span class="math notranslate nohighlight">\(\mathbf{E}^{(m)}_b\)</span> of the background field in this way (<a class="reference external" href="https://doi.org/10.1139/p55-024">Wait
1955</a>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\mathbf{E}^{(m)}_b = \hat{\rho} \left(E_{0} \cos \theta
e^{j k z \cos \theta} j^{-m+1} J_{m}^{\prime}\left(k_{0} \rho \sin
\theta\right)\right)
+\hat{z} \left(E_{0} \sin \theta e^{j k z \cos \theta}j^{-m} J_{m}
\left(k \rho \sin \theta\right)\right)\\
+\hat{\phi} \left(\frac{E_{0} \cos \theta}{k \rho \sin \theta}
e^{j k z \cos \theta} mj^{-m} J_{m}\left(k \rho \sin \theta\right)\right)
\end{split}
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(k = 2\pi n_b/\lambda = k_0n_b\)</span> being the wavevector, <span class="math notranslate nohighlight">\(\theta\)</span>
being the angle between <span class="math notranslate nohighlight">\(\mathbf{E}_b\)</span> and <span class="math notranslate nohighlight">\(\hat{\rho}\)</span>, and <span class="math notranslate nohighlight">\(J_m\)</span>
representing the <span class="math notranslate nohighlight">\(m\)</span>-th order Bessel function of first kind and
<span class="math notranslate nohighlight">\(J_{m}^{\prime}\)</span> its derivative. We implement these functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">background_field_rz</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">k0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">n_bkg</span>
    <span class="n">a_r</span> <span class="o">=</span> <span class="p">(</span>
        <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.cos.html#numpy.cos" title="numpy.cos"><span class="n">np</span><span class="o">.</span><span class="n">cos</span></a><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.exp.html#numpy.exp" title="numpy.exp"><span class="n">np</span><span class="o">.</span><span class="n">exp</span></a><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.cos.html#numpy.cos" title="numpy.cos"><span class="n">np</span><span class="o">.</span><span class="n">cos</span></a><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">jvp</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sin.html#numpy.sin" title="numpy.sin"><span class="n">np</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">a_z</span> <span class="o">=</span> <span class="p">(</span>
        <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sin.html#numpy.sin" title="numpy.sin"><span class="n">np</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.exp.html#numpy.exp" title="numpy.exp"><span class="n">np</span><span class="o">.</span><span class="n">exp</span></a><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.cos.html#numpy.cos" title="numpy.cos"><span class="n">np</span><span class="o">.</span><span class="n">cos</span></a><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="n">m</span>
        <span class="o">*</span> <span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sin.html#numpy.sin" title="numpy.sin"><span class="n">np</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a_r</span><span class="p">,</span> <span class="n">a_z</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">background_field_p</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">k0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">n_bkg</span>
    <span class="n">a_p</span> <span class="o">=</span> <span class="p">(</span>
        <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.cos.html#numpy.cos" title="numpy.cos"><span class="n">np</span><span class="o">.</span><span class="n">cos</span></a><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sin.html#numpy.sin" title="numpy.sin"><span class="n">np</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.exp.html#numpy.exp" title="numpy.exp"><span class="n">np</span><span class="o">.</span><span class="n">exp</span></a><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.cos.html#numpy.cos" title="numpy.cos"><span class="n">np</span><span class="o">.</span><span class="n">cos</span></a><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="o">*</span> <span class="n">m</span>
        <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sin.html#numpy.sin" title="numpy.sin"><span class="n">np</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">a_p</span>
</pre></div>
</div>
<p>PML can be implemented in a spherical shell surrounding the background
domain. We can use the following complex coordinate transformation for
PML:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
&amp;\rho^{\prime} = \rho\left[1 +j \alpha/k_0 \left(\frac{r
- r_{dom}}{r~r_{pml}}\right)\right] \\
&amp;z^{\prime} = z\left[1 +j \alpha/k_0 \left(\frac{r
- r_{dom}}{r~r_{pml}}\right)\right] \\
&amp;\phi^{\prime} = \phi
\end{align}
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(\alpha\)</span> tuning the absorption inside the PML, and <span class="math notranslate nohighlight">\(r =
\sqrt{\rho^2 + z^2}\)</span>. This coordinate transformation has the following
Jacobian:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{J}=\mathbf{A}^{-1}= \nabla\boldsymbol{\rho}^
\prime(\boldsymbol{\rho}) =
\left[\begin{array}{ccc}
\frac{\partial \rho^{\prime}}{\partial \rho} &amp;
\frac{\partial z^{\prime}}{\partial \rho} &amp;
0 \\
\frac{\partial \rho^{\prime}}{\partial z} &amp;
\frac{\partial z^{\prime}}{\partial z} &amp;
0 \\
0 &amp;
0 &amp;
\frac{\rho^\prime}{\rho}\frac{\partial \phi^{\prime}}{\partial \phi}
\end{array}\right]=\left[\begin{array}{ccc}
J_{11} &amp; J_{12} &amp; 0 \\
J_{21} &amp; J_{22} &amp; 0 \\
0 &amp; 0 &amp; J_{33}
\end{array}\right]
\end{split}\]</div>
<p>which we can use to calculate <span class="math notranslate nohighlight">\({\boldsymbol{\varepsilon}_{pml}}\)</span> and
<span class="math notranslate nohighlight">\({\boldsymbol{\mu}_{pml}}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
&amp; {\boldsymbol{\varepsilon}_{pml}} =
A^{-1} \mathbf{A} {\boldsymbol{\varepsilon}_b}\mathbf{A}^{T}\\
&amp; {\boldsymbol{\mu}_{pml}} =
A^{-1} \mathbf{A} {\boldsymbol{\mu}_b}\mathbf{A}^{T}
\end{align}
\end{split}\]</div>
<p>For doing these calculations, we define the <code class="docutils literal notranslate"><span class="pre">pml_coordinate</span></code> and
<code class="docutils literal notranslate"><span class="pre">create_mu_eps</span></code> functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>

<span class="k">def</span><span class="w"> </span><span class="nf">pml_coordinate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">k0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">radius_dom</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">radius_pml</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_eps_mu</span><span class="p">(</span><span class="n">pml</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">eps_bkg</span><span class="p">,</span> <span class="n">mu_bkg</span><span class="p">):</span>
    <span class="n">J</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.grad" title="ufl.grad"><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">pml</span><span class="p">)</span>

    <span class="c1"># Transform the 2x2 Jacobian into a 3x3 matrix.</span>
    <span class="n">J</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.as_matrix" title="ufl.as_matrix"><span class="n">ufl</span><span class="o">.</span><span class="n">as_matrix</span></a><span class="p">(((</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span><span class="p">)))</span>

    <span class="n">A</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inv" title="ufl.inv"><span class="n">ufl</span><span class="o">.</span><span class="n">inv</span></a><span class="p">(</span><span class="n">J</span><span class="p">)</span>
    <span class="n">eps_pml</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.det" title="ufl.det"><span class="n">ufl</span><span class="o">.</span><span class="n">det</span></a><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">eps_bkg</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.transpose" title="ufl.transpose"><span class="n">ufl</span><span class="o">.</span><span class="n">transpose</span></a><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">mu_pml</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.det" title="ufl.det"><span class="n">ufl</span><span class="o">.</span><span class="n">det</span></a><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">mu_bkg</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.transpose" title="ufl.transpose"><span class="n">ufl</span><span class="o">.</span><span class="n">transpose</span></a><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eps_pml</span><span class="p">,</span> <span class="n">mu_pml</span>
</pre></div>
</div>
<p>We can now define some constants and geometrical parameters, and then
we can generate the mesh with Gmsh, by using the function
<code class="docutils literal notranslate"><span class="pre">generate_mesh_sphere_axis</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constants</span>
<span class="n">epsilon_0</span> <span class="o">=</span> <span class="mf">8.8541878128</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">12</span>  <span class="c1"># Vacuum permittivity</span>
<span class="n">mu_0</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span>  <span class="c1"># Vacuum permeability</span>
<span class="n">Z0</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">mu_0</span> <span class="o">/</span> <span class="n">epsilon_0</span><span class="p">)</span>  <span class="c1"># Vacuum impedance</span>

<span class="c1"># Radius of the sphere</span>
<span class="n">radius_sph</span> <span class="o">=</span> <span class="mf">0.025</span>

<span class="c1"># Radius of the domain</span>
<span class="n">radius_dom</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Radius of the boundary where scattering efficiency is calculated</span>
<span class="n">radius_scatt</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">radius_dom</span>

<span class="c1"># Radius of the PML shell</span>
<span class="n">radius_pml</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># Mesh sizes</span>
<span class="n">mesh_factor</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">in_sph_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">2.0e-3</span>
<span class="n">on_sph_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">2.0e-3</span>
<span class="n">scatt_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">60.0e-3</span>
<span class="n">pml_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">40.0e-3</span>

<span class="c1"># Tags for the subdomains</span>
<span class="n">au_tag</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">bkg_tag</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">pml_tag</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">scatt_tag</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Mesh generation</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">generate_mesh_sphere_axis</span><span class="p">(</span>
        <span class="n">radius_sph</span><span class="p">,</span>
        <span class="n">radius_scatt</span><span class="p">,</span>
        <span class="n">radius_dom</span><span class="p">,</span>
        <span class="n">radius_pml</span><span class="p">,</span>
        <span class="n">in_sph_size</span><span class="p">,</span>
        <span class="n">on_sph_size</span><span class="p">,</span>
        <span class="n">scatt_size</span><span class="p">,</span>
        <span class="n">pml_size</span><span class="p">,</span>
        <span class="n">au_tag</span><span class="p">,</span>
        <span class="n">bkg_tag</span><span class="p">,</span>
        <span class="n">pml_tag</span><span class="p">,</span>
        <span class="n">scatt_tag</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.Comm.html#mpi4py.MPI.Comm.bcast" title="mpi4py.MPI.Comm.bcast"><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">bcast</span></a><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">partitioner</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_cell_partitioner</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.cpp.mesh.html#dolfinx.cpp.mesh.GhostMode.shared_facet" title="dolfinx.cpp.mesh.GhostMode.shared_facet"><span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">GhostMode</span><span class="o">.</span><span class="n">shared_facet</span></a><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData" title="dolfinx.io.gmsh.MeshData"><span class="n">mesh_data</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.model_to_mesh" title="dolfinx.io.gmsh.model_to_mesh"><span class="n">io</span><span class="o">.</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model_to_mesh</span></a><span class="p">(</span><span class="n">model</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.COMM_WORLD.html#mpi4py.MPI.COMM_WORLD" title="mpi4py.MPI.COMM_WORLD"><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span></a><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">partitioner</span><span class="o">=</span><span class="n">partitioner</span><span class="p">)</span>
<span class="k">assert</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.cell_tags" title="dolfinx.io.gmsh.MeshData.cell_tags"><span class="n">mesh_data</span><span class="o">.</span><span class="n">cell_tags</span></a> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"Cell tags are missing"</span>
<span class="k">assert</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.facet_tags" title="dolfinx.io.gmsh.MeshData.facet_tags"><span class="n">mesh_data</span><span class="o">.</span><span class="n">facet_tags</span></a> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"Facet tags are missing"</span>

<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.Comm.html#mpi4py.MPI.Comm.barrier" title="mpi4py.MPI.Comm.barrier"><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">barrier</span></a><span class="p">()</span>
</pre></div>
</div>
<p>Visually check of the mesh and of the subdomains using PyVista:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ffcx/v0.10.0/_autogenerated/ffcx.options.html#ffcx.options.Path" title="pathlib.Path"><span class="n">out_folder</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ffcx/v0.10.0/_autogenerated/ffcx.options.html#ffcx.options.Path" title="pathlib.Path"><span class="n">Path</span></a><span class="p">(</span><span class="s2">"out_axis"</span><span class="p">)</span>
<span class="n">out_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tdim</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
<span class="k">if</span> <span class="n">have_pyvista</span><span class="p">:</span>
    <span class="n">topology</span><span class="p">,</span> <span class="n">cell_types</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.plot.html#dolfinx.plot.vtk_mesh" title="dolfinx.plot.vtk_mesh"><span class="n">plot</span><span class="o">.</span><span class="n">vtk_mesh</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.pyvista.org/api/core/_autosummary/pyvista.UnstructuredGrid.html#pyvista.UnstructuredGrid" title="pyvista.UnstructuredGrid"><span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span></a><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">cell_types</span><span class="p">,</span> <span class="n">geometry</span><span class="p">)</span>
    <span class="n">plotter</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.pyvista.org/api/plotting/_autosummary/pyvista.Plotter.html#pyvista.Plotter" title="pyvista.Plotter"><span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span></a><span class="p">()</span>
    <span class="n">num_local_cells</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="n">tdim</span><span class="p">)</span><span class="o">.</span><span class="n">size_local</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">"Marker"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
        <span class="n">mesh_data</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">indices</span> <span class="o">&lt;</span> <span class="n">num_local_cells</span>
    <span class="p">]</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">"Marker"</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">OFF_SCREEN</span><span class="p">:</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ffcx/v0.10.0/_autogenerated/ffcx.options.html#ffcx.options.Path" title="pathlib.Path"><span class="n">out_folder</span></a> <span class="o">/</span> <span class="s2">"sphere_axis_mesh.png"</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>
</pre></div>
</div>
<p>For the <span class="math notranslate nohighlight">\(\hat{\rho}\)</span> and <span class="math notranslate nohighlight">\(\hat{z}\)</span> components of the electric field,
we will use Nedelec elements, while for the <span class="math notranslate nohighlight">\(\hat{\phi}\)</span> components we
will use Lagrange elements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">degree</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">curl_el</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#basix.ufl.element" title="basix.ufl.element"><span class="n">element</span></a><span class="p">(</span><span class="s2">"N1curl"</span><span class="p">,</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="n">degree</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">PETSc</span><span class="o">.</span><span class="n">RealType</span></a><span class="p">)</span>
<span class="n">lagr_el</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#basix.ufl.element" title="basix.ufl.element"><span class="n">element</span></a><span class="p">(</span><span class="s2">"Lagrange"</span><span class="p">,</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="n">degree</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">PETSc</span><span class="o">.</span><span class="n">RealType</span></a><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.functionspace" title="dolfinx.fem.functionspace"><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#basix.ufl.mixed_element" title="basix.ufl.mixed_element"><span class="n">mixed_element</span></a><span class="p">([</span><span class="n">curl_el</span><span class="p">,</span> <span class="n">lagr_el</span><span class="p">]))</span>
</pre></div>
</div>
<p>The integration domains of our problem are the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Measures for subdomains</span>
<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span></a><span class="p">(</span>
    <span class="s2">"dx"</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.cell_tags" title="dolfinx.io.gmsh.MeshData.cell_tags"><span class="n">mesh_data</span><span class="o">.</span><span class="n">cell_tags</span></a><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">"quadrature_degree"</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">dDom</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx</span></a><span class="p">((</span><span class="n">au_tag</span><span class="p">,</span> <span class="n">bkg_tag</span><span class="p">))</span>
<span class="n">dPml</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx</span></a><span class="p">(</span><span class="n">pml_tag</span><span class="p">)</span>
</pre></div>
</div>
<p>The <span class="math notranslate nohighlight">\(\varepsilon_r\)</span> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_bkg</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Background refractive index</span>
<span class="n">eps_bkg</span> <span class="o">=</span> <span class="n">n_bkg</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Background relative permittivity</span>
<span class="n">eps_au</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0782</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">5.8089</span>

<span class="n">D</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.functionspace" title="dolfinx.fem.functionspace"><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <span class="p">(</span><span class="s2">"DG"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">eps</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<span class="n">au_cells</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">au_tag</span><span class="p">)</span>
<span class="n">bkg_cells</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">bkg_tag</span><span class="p">)</span>
<span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">au_cells</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.full_like.html#numpy.full_like" title="numpy.full_like"><span class="n">np</span><span class="o">.</span><span class="n">full_like</span></a><span class="p">(</span><span class="n">au_cells</span><span class="p">,</span> <span class="n">eps_au</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">bkg_cells</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.full_like.html#numpy.full_like" title="numpy.full_like"><span class="n">np</span><span class="o">.</span><span class="n">full_like</span></a><span class="p">(</span><span class="n">bkg_cells</span><span class="p">,</span> <span class="n">eps_bkg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">scatter_forward</span><span class="p">()</span>
</pre></div>
</div>
<p>For the background field, we need to specify the wavelength (and the
wavevector), angle of incidence, harmonic numbers and the intensity:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wl0</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># Wavelength of the background field</span>
<span class="n">k0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="n">wl0</span>  <span class="c1"># Wavevector of the background field</span>
<span class="n">theta</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">4</span>  <span class="c1"># Angle of incidence of the background field</span>
<span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># list of harmonics</span>
<span class="n">I0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_bkg</span> <span class="o">/</span> <span class="n">Z0</span>  <span class="c1"># Intensity</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">m_list</span></code> contains the harmonic numbers we want to solve for. In
general, we would need to solve for <span class="math notranslate nohighlight">\(m\in \mathbb{Z}\)</span>. However, for
sub-wavelength structure (as our sphere), we can limit the calculation
to few harmonic numbers, e.g., <span class="math notranslate nohighlight">\(m = -1, 0, 1\)</span>. Besides, we have that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
&amp;J_{-m}=(-1)^m J_m \\
&amp;J_{-m}^{\prime}=(-1)^m J_m^{\prime} \\
&amp;j^{-m}=(-1)^m j^m
\end{align}
\end{split}\]</div>
<p>and therefore:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
&amp;E_{b, \rho}^{(m)}=E_{b, \rho}^{(-m)} \\
&amp;E_{b, \phi}^{(m)}=-E_{b, \phi}^{(-m)} \\
&amp;E_{b, z}^{(m)}=E_{b, z}^{(-m)}
\end{align}
\end{split}\]</div>
<p>In light of this, we can solve the problem for <span class="math notranslate nohighlight">\(m\geq 0\)</span>.</p>
<p>We now now define <code class="docutils literal notranslate"><span class="pre">eps_pml</span></code> and <code class="docutils literal notranslate"><span class="pre">mu_pml</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rho</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">r</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.sqrt" title="ufl.sqrt"><span class="n">ufl</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">rho</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">pml_coords</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.as_vector" title="ufl.as_vector"><span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span></a><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">pml_coordinate</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">),</span>
        <span class="n">pml_coordinate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">eps_pml</span><span class="p">,</span> <span class="n">mu_pml</span> <span class="o">=</span> <span class="n">create_eps_mu</span><span class="p">(</span><span class="n">pml_coords</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">eps_bkg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Define other objects that will be used inside our solver loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total field</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Esh</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">V</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">n</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">ufl</span><span class="o">.</span><span class="n">FacetNormal</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">)</span>
<span class="n">n_3d</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.as_vector" title="ufl.as_vector"><span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span></a><span class="p">((</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">n</span></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">n</span></a><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># Geometrical cross section of the sphere, for efficiency calculation</span>
<span class="n">gcs</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <span class="n">radius_sph</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Marker functions for the scattering efficiency integral</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">marker</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<span class="n">scatt_facets</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)</span>
<span class="n">incident_cells</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.compute_incident_entities" title="dolfinx.mesh.compute_incident_entities"><span class="n">mesh</span><span class="o">.</span><span class="n">compute_incident_entities</span></a><span class="p">(</span>
    <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">scatt_facets</span><span class="p">,</span> <span class="n">tdim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tdim</span>
<span class="p">)</span>
<span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">create_connectivity</span><span class="p">(</span><span class="n">tdim</span><span class="p">,</span> <span class="n">tdim</span><span class="p">)</span>
<span class="n">midpoints</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.compute_midpoints" title="dolfinx.mesh.compute_midpoints"><span class="n">mesh</span><span class="o">.</span><span class="n">compute_midpoints</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <span class="n">tdim</span><span class="p">,</span> <span class="n">incident_cells</span><span class="p">)</span>
<span class="n">inner_cells</span> <span class="o">=</span> <span class="n">incident_cells</span><span class="p">[(</span><span class="n">midpoints</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">midpoints</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">radius_scatt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">marker</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">inner_cells</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Define integration domain for the gold sphere</span>
<span class="n">dAu</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx</span></a><span class="p">(</span><span class="n">au_tag</span><span class="p">)</span>

<span class="c1"># Define integration facet for the scattering efficiency</span>
<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dS</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span></a><span class="p">(</span><span class="s2">"dS"</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.facet_tags" title="dolfinx.io.gmsh.MeshData.facet_tags"><span class="n">mesh_data</span><span class="o">.</span><span class="n">facet_tags</span></a><span class="p">)</span>
</pre></div>
</div>
<p>We also specify a variable <code class="docutils literal notranslate"><span class="pre">phi</span></code>, corresponding to the <span class="math notranslate nohighlight">\(\phi\)</span> angle of
the cylindrical coordinate system that we will use to post-process the
field and save it along the plane at <span class="math notranslate nohighlight">\(\phi = \pi/4\)</span>. In particular,
the scattered field needs to be transformed for <span class="math notranslate nohighlight">\(m\neq 0\)</span> in the
following way:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
&amp;E_{s, \rho}^{(m)}(\phi)=E_{s, \rho}^{(m)}(e^{-jm\phi}+e^{jm\phi}) \\
&amp;E_{s, \phi}^{(m)}(\phi)=E_{s, \phi}^{(m)}(e^{-jm\phi}-e^{jm\phi}) \\
&amp;E_{s, z}^{(m)}(\phi)=E_{s, z}^{(m)}(e^{-jm\phi}+e^{jm\phi})
\end{align}
\end{split}\]</div>
<p>For this reason, we also add a <code class="docutils literal notranslate"><span class="pre">phase</span></code> constant for the above phase
term:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">phi</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">/</span> <span class="mi">4</span>

<span class="c1"># Initialize phase term</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.exp.html#numpy.exp" title="numpy.exp"><span class="n">np</span><span class="o">.</span><span class="n">exp</span></a><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)))</span>
</pre></div>
</div>
<p>We now solve the problem:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">m_list</span><span class="p">:</span>
    <span class="c1"># Definition of Trial and Test functions</span>
    <span class="n">Es_m</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.TrialFunction" title="ufl.TrialFunction"><span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span></a><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">v_m</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.TestFunction" title="ufl.TestFunction"><span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span></a><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="c1"># Background field</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eb_m</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">f_rz</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">background_field_rz</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">f_p</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">background_field_p</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">Eb_m</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">f_rz</span><span class="p">)</span>
    <span class="n">Eb_m</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">f_p</span><span class="p">)</span>

    <span class="n">curl_Es_m</span> <span class="o">=</span> <span class="n">curl_axis</span><span class="p">(</span><span class="n">Es_m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
    <span class="n">curl_v_m</span> <span class="o">=</span> <span class="n">curl_axis</span><span class="p">(</span><span class="n">v_m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">-</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">curl_Es_m</span><span class="p">,</span> <span class="n">curl_v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dDom</span>
        <span class="o">+</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">eps</span></a> <span class="o">*</span> <span class="n">k0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">Es_m</span><span class="p">,</span> <span class="n">v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dDom</span>
        <span class="o">+</span> <span class="n">k0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">eps</span></a> <span class="o">-</span> <span class="n">eps_bkg</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eb_m</span></a><span class="p">,</span> <span class="n">v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dDom</span>
        <span class="o">-</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inv" title="ufl.inv"><span class="n">ufl</span><span class="o">.</span><span class="n">inv</span></a><span class="p">(</span><span class="n">mu_pml</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl_Es_m</span><span class="p">,</span> <span class="n">curl_v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dPml</span>
        <span class="o">+</span> <span class="n">k0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">eps_pml</span> <span class="o">*</span> <span class="n">Es_m</span><span class="p">,</span> <span class="n">v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dPml</span>
    <span class="p">)</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.lhs" title="ufl.lhs"><span class="n">ufl</span><span class="o">.</span><span class="n">lhs</span></a><span class="p">(</span><span class="n">F</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.rhs" title="ufl.rhs"><span class="n">ufl</span><span class="o">.</span><span class="n">rhs</span></a><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Sys.html#petsc4py.PETSc.Sys" title="petsc4py.PETSc.Sys"><span class="n">sys</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Sys.html#petsc4py.PETSc.Sys" title="petsc4py.PETSc.Sys"><span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span></a><span class="p">()</span>  <span class="c1"># type: ignore</span>
    <span class="n">use_superlu</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.int32" title="numpy.int32"><span class="n">PETSc</span><span class="o">.</span><span class="n">IntType</span></a> <span class="o">==</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.int64" title="numpy.int64"><span class="n">np</span><span class="o">.</span><span class="n">int64</span></a>
    <span class="k">if</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Sys.html#petsc4py.PETSc.Sys.hasExternalPackage" title="petsc4py.PETSc.Sys.hasExternalPackage"><span class="n">sys</span><span class="o">.</span><span class="n">hasExternalPackage</span></a><span class="p">(</span><span class="s2">"mumps"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_superlu</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="n">mat_factor_backend</span> <span class="o">=</span> <span class="s2">"mumps"</span>
    <span class="k">elif</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Sys.html#petsc4py.PETSc.Sys.hasExternalPackage" title="petsc4py.PETSc.Sys.hasExternalPackage"><span class="n">sys</span><span class="o">.</span><span class="n">hasExternalPackage</span></a><span class="p">(</span><span class="s2">"superlu_dist"</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="n">mat_factor_backend</span> <span class="o">=</span> <span class="s2">"superlu_dist"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"This demo requires a parallel linear algebra backend."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat_factor_backend</span> <span class="o">=</span> <span class="s2">"petsc"</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.LinearProblem" title="dolfinx.fem.petsc.LinearProblem"><span class="n">problem</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.LinearProblem" title="dolfinx.fem.petsc.LinearProblem"><span class="n">LinearProblem</span></a><span class="p">(</span>
        <span class="n">a</span><span class="p">,</span>
        <span class="n">L</span><span class="p">,</span>
        <span class="n">bcs</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">petsc_options_prefix</span><span class="o">=</span><span class="s2">"demo_axis_"</span><span class="p">,</span>
        <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">"ksp_type"</span><span class="p">:</span> <span class="s2">"preonly"</span><span class="p">,</span>
            <span class="s2">"pc_type"</span><span class="p">:</span> <span class="s2">"lu"</span><span class="p">,</span>
            <span class="s2">"pc_factor_mat_solver_type"</span><span class="p">:</span> <span class="n">mat_factor_backend</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">Esh_m</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.LinearProblem.solve" title="dolfinx.fem.petsc.LinearProblem.solve"><span class="n">problem</span><span class="o">.</span><span class="n">solve</span></a><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">)</span>
    <span class="k">assert</span> <span class="n">problem</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">getConvergedReason</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Scattered magnetic field</span>
    <span class="n">Hsh_m</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">curl_axis</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z0</span> <span class="o">*</span> <span class="n">k0</span><span class="p">)</span>

    <span class="c1"># Total electric field</span>
    <span class="n">Eh_m</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Eb_m</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">Esh_m</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span>

    <span class="c1"># We can add our solution to the total scattered field, which also</span>
    <span class="c1"># includes the transformation to the $\phi$ plane:</span>

    <span class="n">phase</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.exp.html#numpy.exp" title="numpy.exp"><span class="n">np</span><span class="o">.</span><span class="n">exp</span></a><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
    <span class="n">rotate_to_phi</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.as_vector" title="ufl.as_vector"><span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span></a><span class="p">(</span>
        <span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a> <span class="o">+</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.conj" title="ufl.conj"><span class="n">ufl</span><span class="o">.</span><span class="n">conj</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a><span class="p">),</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a> <span class="o">+</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.conj" title="ufl.conj"><span class="n">ufl</span><span class="o">.</span><span class="n">conj</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a><span class="p">),</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a> <span class="o">-</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.conj" title="ufl.conj"><span class="n">ufl</span><span class="o">.</span><span class="n">conj</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">phase</span></a><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># initialize and do not transform</span>
        <span class="n">Esh</span> <span class="o">=</span> <span class="n">Esh_m</span>
    <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># initialize and transform</span>
        <span class="n">Esh</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.elem_mult" title="ufl.elem_mult"><span class="n">ufl</span><span class="o">.</span><span class="n">elem_mult</span></a><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">rotate_to_phi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transform</span>
        <span class="n">Esh</span> <span class="o">+=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.elem_mult" title="ufl.elem_mult"><span class="n">ufl</span><span class="o">.</span><span class="n">elem_mult</span></a><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">rotate_to_phi</span><span class="p">)</span>

    <span class="c1"># To check that  our calculations are correct, we can use as reference</span>
    <span class="c1"># quantities the absorption and scattering efficiencies:</span>

    <span class="c1"># +</span>
    <span class="c1"># Efficiencies calculation</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># initialize and do not add 2 factor</span>
        <span class="n">P</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="o">-</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.cross" title="ufl.cross"><span class="n">ufl</span><span class="o">.</span><span class="n">cross</span></a><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.conj" title="ufl.conj"><span class="n">ufl</span><span class="o">.</span><span class="n">conj</span></a><span class="p">(</span><span class="n">Hsh_m</span><span class="p">)),</span> <span class="n">n_3d</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">marker</span></a>
        <span class="n">Q</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <span class="n">eps_au</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a><span class="p">))</span> <span class="o">/</span> <span class="n">Z0</span>
        <span class="n">q_abs_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dAu</span><span class="p">))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_sca_fenics_proc</span> <span class="o">=</span> <span class="p">(</span>
            <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">((</span><span class="n">P</span><span class="p">(</span><span class="s2">"+"</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="s2">"-"</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dS</span></a><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span>
        <span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_abs_fenics</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_abs_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">)</span>
        <span class="n">q_sca_fenics</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_sca_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">)</span>
    <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># initialize and add 2 factor</span>
        <span class="n">P</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="o">-</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.cross" title="ufl.cross"><span class="n">ufl</span><span class="o">.</span><span class="n">cross</span></a><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.conj" title="ufl.conj"><span class="n">ufl</span><span class="o">.</span><span class="n">conj</span></a><span class="p">(</span><span class="n">Hsh_m</span><span class="p">)),</span> <span class="n">n_3d</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">marker</span></a>
        <span class="n">Q</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <span class="n">eps_au</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a><span class="p">))</span> <span class="o">/</span> <span class="n">Z0</span> <span class="o">/</span> <span class="n">n_bkg</span>
        <span class="n">q_abs_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dAu</span><span class="p">))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_sca_fenics_proc</span> <span class="o">=</span> <span class="p">(</span>
            <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">((</span><span class="n">P</span><span class="p">(</span><span class="s2">"+"</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="s2">"-"</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dS</span></a><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span>
        <span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_abs_fenics</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_abs_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">)</span>
        <span class="n">q_sca_fenics</span> <span class="o">=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_sca_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># do not initialize and add 2 factor</span>
        <span class="n">P</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="o">-</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.cross" title="ufl.cross"><span class="n">ufl</span><span class="o">.</span><span class="n">cross</span></a><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.conj" title="ufl.conj"><span class="n">ufl</span><span class="o">.</span><span class="n">conj</span></a><span class="p">(</span><span class="n">Hsh_m</span><span class="p">)),</span> <span class="n">n_3d</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">marker</span></a>
        <span class="n">Q</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a> <span class="o">*</span> <span class="n">eps_au</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Eh_m</span></a><span class="p">))</span> <span class="o">/</span> <span class="n">Z0</span> <span class="o">/</span> <span class="n">n_bkg</span>
        <span class="n">q_abs_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dAu</span><span class="p">))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_sca_fenics_proc</span> <span class="o">=</span> <span class="p">(</span>
            <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">((</span><span class="n">P</span><span class="p">(</span><span class="s2">"+"</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="s2">"-"</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dS</span></a><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span>
        <span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_abs_fenics</span> <span class="o">+=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_abs_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">)</span>
        <span class="n">q_sca_fenics</span> <span class="o">+=</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_sca_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q_ext_fenics</span> <span class="o">=</span> <span class="n">q_abs_fenics</span> <span class="o">+</span> <span class="n">q_sca_fenics</span>
<span class="c1"># -</span>
</pre></div>
</div>
<p>The quantities <code class="docutils literal notranslate"><span class="pre">P</span></code> and <code class="docutils literal notranslate"><span class="pre">Q</span></code> have an additional <code class="docutils literal notranslate"><span class="pre">2</span></code> factor for <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">!=</span> <span class="pre">0</span></code>
due to parity.</p>
<p>We now compare the numerical and analytical efficiencies (he latter
were obtained with the following routine provided by the
<a class="reference external" href="https://github.com/ovidiopr/scattnlay"><code class="docutils literal notranslate"><span class="pre">scattnlay</span></code></a> library):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scattnlay</span><span class="w"> </span><span class="kn">import</span> <span class="n">scattnlay</span>

<span class="n">m</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">eps_au</span><span class="p">)</span><span class="o">/</span><span class="n">n_bkg</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/constants.html#numpy.pi" title="numpy.pi"><span class="n">np</span><span class="o">.</span><span class="n">pi</span></a><span class="o">*</span><span class="n">radius_sph</span><span class="o">/</span><span class="n">wl0</span><span class="o">*</span><span class="n">n_bkg</span>

<span class="n">q_sca_analyt</span><span class="p">,</span> <span class="n">q_abs_analyt</span> <span class="o">=</span> <span class="n">scattnlay</span><span class="p">(</span>
  <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.complex128" title="numpy.complex128"><span class="n">np</span><span class="o">.</span><span class="n">complex128</span></a><span class="p">),</span>
  <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="n">m</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.complex128" title="numpy.complex128"><span class="n">np</span><span class="o">.</span><span class="n">complex128</span></a><span class="p">)</span>
<span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
<p>The numerical values are reported here below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q_abs_analyt</span> <span class="o">=</span> <span class="mf">0.9622728008329892</span>
<span class="n">q_sca_analyt</span> <span class="o">=</span> <span class="mf">0.07770397394691526</span>
<span class="n">q_ext_analyt</span> <span class="o">=</span> <span class="n">q_abs_analyt</span> <span class="o">+</span> <span class="n">q_sca_analyt</span>
</pre></div>
</div>
<p>Finally, we can calculate the error and save our total scattered
field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Error calculation</span>
<span class="n">err_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_abs_analyt</span> <span class="o">-</span> <span class="n">q_abs_fenics</span><span class="p">)</span> <span class="o">/</span> <span class="n">q_abs_analyt</span>
<span class="n">err_sca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_sca_analyt</span> <span class="o">-</span> <span class="n">q_sca_fenics</span><span class="p">)</span> <span class="o">/</span> <span class="n">q_sca_analyt</span>
<span class="n">err_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_ext_analyt</span> <span class="o">-</span> <span class="n">q_ext_fenics</span><span class="p">)</span> <span class="o">/</span> <span class="n">q_ext_analyt</span>

<span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The analytical absorption efficiency is </span><span class="si">{</span><span class="n">q_abs_analyt</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The numerical absorption efficiency is </span><span class="si">{</span><span class="n">q_abs_fenics</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The error is </span><span class="si">{</span><span class="n">err_abs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The analytical scattering efficiency is </span><span class="si">{</span><span class="n">q_sca_analyt</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The numerical scattering efficiency is </span><span class="si">{</span><span class="n">q_sca_fenics</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The error is </span><span class="si">{</span><span class="n">err_sca</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The analytical extinction efficiency is </span><span class="si">{</span><span class="n">q_ext_analyt</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The numerical extinction efficiency is </span><span class="si">{</span><span class="n">q_ext_fenics</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The error is </span><span class="si">{</span><span class="n">err_ext</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>

<span class="c1"># Check whether the geometrical and optical parameters are correct</span>
<span class="c1"># assert radius_sph / wl0 == 0.025 / 0.4</span>
<span class="c1"># assert eps_au == -1.0782 + 1j * 5.8089</span>
<span class="c1"># assert err_abs &lt; 0.01</span>
<span class="c1"># assert err_sca &lt; 0.01</span>
<span class="c1"># assert err_ext &lt; 0.01</span>

<span class="k">if</span> <span class="n">has_vtx</span><span class="p">:</span>
    <span class="n">v_dg_el</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/basix/v0.10.0/python/_autosummary/basix.ufl.html#basix.ufl.element" title="basix.ufl.element"><span class="n">element</span></a><span class="p">(</span><span class="s2">"DG"</span><span class="p">,</span> <span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="n">degree</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">PETSc</span><span class="o">.</span><span class="n">RealType</span></a><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.functionspace" title="dolfinx.fem.functionspace"><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.gmsh.html#dolfinx.io.gmsh.MeshData.mesh" title="dolfinx.io.gmsh.MeshData.mesh"><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span></a><span class="p">,</span> <span class="n">v_dg_el</span><span class="p">)</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Es_dg</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">W</span><span class="p">)</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Expression" title="dolfinx.fem.function.Expression"><span class="n">Es_expr</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Expression" title="dolfinx.fem.function.Expression"><span class="n">fem</span><span class="o">.</span><span class="n">Expression</span></a><span class="p">(</span><span class="n">Esh</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">interpolation_points</span><span class="p">)</span>
    <span class="n">Es_dg</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Expression" title="dolfinx.fem.function.Expression"><span class="n">Es_expr</span></a><span class="p">)</span>
    <span class="k">with</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#dolfinx.io.VTXWriter" title="dolfinx.io.utils.VTXWriter"><span class="n">VTXWriter</span></a><span class="p">(</span><span class="n">mesh_data</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ffcx/v0.10.0/_autogenerated/ffcx.options.html#ffcx.options.Path" title="pathlib.Path"><span class="n">out_folder</span></a> <span class="o">/</span> <span class="s2">"Es.bp"</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">Es_dg</span></a><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</div>
</div>
<footer><div aria-label="Footer" class="rst-footer-buttons" role="navigation">
<a accesskey="p" class="btn btn-neutral float-left" href="demo_half_loaded_waveguide.html" rel="prev" title="Electromagnetic modal analysis for a waveguide"><span aria-hidden="true" class="fa fa-arrow-circle-left"></span> Previous</a>
<a accesskey="n" class="btn btn-neutral float-right" href="demo_mixed-poisson.html" rel="next" title="Mixed formulation of the Poisson equation with a block-preconditioner/solver # noqa">Next <span aria-hidden="true" class="fa fa-arrow-circle-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<p>© Copyright 2025, FEniCS Project.</p>
</div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
</div>
</div>
</section>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
</body>
</html>
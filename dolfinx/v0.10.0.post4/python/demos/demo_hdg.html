
<!DOCTYPE html>

<html class="writer-html5" data-content_root="../" lang="en">
<head>
<meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>HDG scheme for the Poisson equation — DOLFINx 0.10.0.post4 documentation</title>
<link href="../_static/pygments.css?v=03e43079" rel="stylesheet" type="text/css"/>
<link href="../_static/css/theme.css?v=e59714d7" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-codeautolink.css?v=b2176991" rel="stylesheet" type="text/css"/>
<script src="../_static/jquery.js?v=5d32c60e"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
<script src="../_static/documentation_options.js?v=2d828448"></script>
<script src="../_static/doctools.js?v=9bcbadda"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/js/theme.js"></script>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="demo_mixed-topology.html" rel="next" title="Poisson equation"/>
<link href="demo_pyamg.html" rel="prev" title="Solve the Poisson and linearised elasticity equations using pyamg"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../index.html">
            DOLFINx
          </a>
<div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../demos.html">Demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../demos.html#pdes-introductory">PDEs (introductory)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../demos.html#pdes-advanced">PDEs (advanced)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-poisson.html">Mixed formulation of the Poisson equation with a block-preconditioner/solver # noqa</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_stokes.html">Stokes equations using Taylor-Hood elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_navier-stokes.html">Divergence conforming discontinuous Galerkin method for the Navier–Stokes equations # noqa</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_elasticity.html">Elasticity using algebraic multigrid</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_cahn-hilliard.html">Cahn-Hilliard equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_static-condensation.html">Static condensation of linear elasticity</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_biharmonic.html">Biharmonic equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_types.html">Solving PDEs with different scalar (float) types</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_poisson_matrix_free.html">Matrix-free conjugate gradient solver for the Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pyamg.html">Solve the Poisson and linearised elasticity equations using pyamg</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">HDG scheme for the Poisson equation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#define-integration-measures">Define integration measures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#variational-formulation">Variational formulation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-topology.html">Poisson equation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#nonlinear-problems">Nonlinear problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#mesh-generation">Mesh generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#interpolation-io-and-visualisation">Interpolation, IO and visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#advanced-iterative-solvers">Advanced iterative solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#user-defined-and-advanced-finite-elements">User-defined and advanced finite elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#parallel-communication-analysis">Parallel communication analysis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../demos.html#list-of-all-demos">List of all demos</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_poisson.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_biharmonic.html">Biharmonic equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_cahn-hilliard.html">Cahn-Hilliard equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_stokes.html">Stokes equations using Taylor-Hood elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_elasticity.html">Elasticity using algebraic multigrid</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_gmsh.html">Mesh generation with Gmsh</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_helmholtz.html">Helmholtz equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_static-condensation.html">Static condensation of linear elasticity</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pyvista.html">Visualization with PyVista</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_interpolation-io.html">Interpolation and IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_types.html">Solving PDEs with different scalar (float) types</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_lagrange_variants.html">Variants of Lagrange elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_tnt-elements.html">Creating TNT elements using Basix’s custom element interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_scattering_boundary_conditions.html">Electromagnetic scattering from a wire with scattering BCs</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html">Electromagnetic scattering from a wire with PML</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html#mesh-generation-with-gmsh">Mesh generation with GMSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_half_loaded_waveguide.html">Electromagnetic modal analysis for a waveguide</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_axis.html">Electromagnetic scattering from a sphere (axisymmetric)</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_navier-stokes.html">Divergence conforming discontinuous Galerkin method for the Navier–Stokes equations # noqa</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-poisson.html">Mixed formulation of the Poisson equation with a block-preconditioner/solver # noqa</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pyamg.html">Solve the Poisson and linearised elasticity equations using pyamg</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">HDG scheme for the Poisson equation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#define-integration-measures">Define integration measures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#variational-formulation">Variational formulation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-topology.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_comm-pattern.html">Parallel communication pattern analysis</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../index.html">DOLFINx</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="Page navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Home" class="icon icon-home" href="../index.html"></a></li>
<li class="breadcrumb-item"><a href="../demos.html">Demos</a></li>
<li class="breadcrumb-item active">HDG scheme for the Poisson equation</li>
<li class="wy-breadcrumbs-aside">
<a href="../_sources/demos/demo_hdg.md.txt" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<section class="tex2jax_ignore mathjax_ignore" id="hdg-scheme-for-the-poisson-equation">
<h1>HDG scheme for the Poisson equation<a class="headerlink" href="#hdg-scheme-for-the-poisson-equation" title="Link to this heading"></a></h1>
<div class="download admonition">
<p class="admonition-title">Download sources</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../_downloads/3e7291d3b77b3f22251cd7795a639a00/demo_hdg.py"><code class="xref download docutils literal notranslate"><span class="pre">Python</span> <span class="pre">script</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="../_downloads/3a2e8b3062e32f7fa335a0116fae9bef/demo_hdg.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Jupyter</span> <span class="pre">notebook</span></code></a></p></li>
</ul>
</div>
<p>This demo illustrates how to:</p>
<ul class="simple">
<li><p>Solve Poisson’s equation using an HDG scheme.</p></li>
<li><p>Defining custom integration domains</p></li>
<li><p>Create a submesh over all facets of the mesh</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">ufl.MixedFunctionSpace</span></code> to defined blocked problems.</p></li>
<li><p>Assemble mixed systems with multiple, related meshes</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/mpi4py.html#module-mpi4py" title="mpi4py"><span class="nn">mpi4py</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.html#module-mpi4py.MPI" title="mpi4py.MPI"><span class="n">MPI</span></a>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.html#module-petsc4py" title="petsc4py"><span class="nn">petsc4py</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.html#module-petsc4py.PETSc" title="petsc4py.PETSc"><span class="n">PETSc</span></a>

<span class="kn">import</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/index.html#module-numpy" title="numpy"><span class="nn">numpy</span></a><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">dolfinx</span>
<span class="kn">import</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#module-ufl" title="ufl"><span class="nn">ufl</span></a>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx</span><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#module-dolfinx.fem" title="dolfinx.fem"><span class="n">fem</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#module-dolfinx.mesh" title="dolfinx.mesh"><span class="n">mesh</span></a>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.cpp.mesh.html#module-dolfinx.cpp.mesh" title="dolfinx.cpp.mesh"><span class="nn">dolfinx.cpp.mesh</span></a><span class="w"> </span><span class="kn">import</span> <span class="n">cell_num_entities</span>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#module-dolfinx.fem" title="dolfinx.fem"><span class="nn">dolfinx.fem</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.extract_function_spaces" title="dolfinx.fem.extract_function_spaces"><span class="n">extract_function_spaces</span></a>
<span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#module-dolfinx.fem.petsc" title="dolfinx.fem.petsc"><span class="nn">dolfinx.fem.petsc</span></a><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.apply_lifting" title="dolfinx.fem.petsc.apply_lifting"><span class="n">apply_lifting</span></a><span class="p">,</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.assemble_matrix" title="dolfinx.fem.petsc.assemble_matrix"><span class="n">assemble_matrix</span></a><span class="p">,</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.assemble_vector" title="dolfinx.fem.petsc.assemble_vector"><span class="n">assemble_vector</span></a><span class="p">,</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.assign" title="dolfinx.fem.petsc.assign"><span class="n">assign</span></a><span class="p">,</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.create_vector" title="dolfinx.fem.petsc.create_vector"><span class="n">create_vector</span></a><span class="p">,</span>
    <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.set_bc" title="dolfinx.fem.petsc.set_bc"><span class="n">set_bc</span></a><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We start by creating two convenience functions: One to compute
the L2 norm of a UFL expression, and one to define the integration
domains for the facets of all cells in a mesh.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">norm_L2</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.core.html#ufl.core.expr.Expr" title="ufl.core.expr.Expr"><span class="n">v</span></a><span class="p">:</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.core.html#ufl.core.expr.Expr" title="ufl.core.expr.Expr"><span class="n">ufl</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">Expr</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">measure</span></a><span class="p">:</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span></a> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span> <span class="o">-&gt;</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.inexact" title="numpy.inexact"><span class="n">np</span><span class="o">.</span><span class="n">inexact</span></a><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convenience function to compute the L2 norm of a UFL expression."""</span>
    <span class="n">compiled_form</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.core.html#ufl.core.expr.Expr" title="ufl.core.expr.Expr"><span class="n">v</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.core.html#ufl.core.expr.Expr" title="ufl.core.expr.Expr"><span class="n">v</span></a><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">measure</span></a><span class="p">)</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">compiled_form</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span>
    <span class="k">return</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.assemble_scalar" title="dolfinx.fem.assemble_scalar"><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span></a><span class="p">(</span><span class="n">compiled_form</span><span class="p">),</span> <span class="n">op</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.SUM.html#mpi4py.MPI.SUM" title="mpi4py.MPI.SUM"><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span></a><span class="p">))</span>
</pre></div>
</div>
<p>In DOLFINx, we represent integration domains over entities of
codimension &gt; 0 as a tuple <code class="docutils literal notranslate"><span class="pre">(cell_idx,</span> <span class="pre">local_entity_idx)</span></code>,
where <code class="docutils literal notranslate"><span class="pre">cell_idx</span></code> is the index of the cell in the mesh
(local to process), and <code class="docutils literal notranslate"><span class="pre">local_entity_idx</span></code> is the local index
of the sub entity (local to cell). For the HDG scheme, we will
integrate over the facets of each cell (for internal facets,
there will be repeat entries, from the viewpoint of the connected cells).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_boundary_facets</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">:</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh</span></a><span class="p">)</span> <span class="o">-&gt;</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span></a><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Compute the integration entities for integrals around the</span>
<span class="sd">    boundaries of all cells in msh.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        msh: The mesh.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Facets to integrate over, identified by ``(cell, local facet</span>
<span class="sd">        index)`` pairs.</span>
<span class="sd">    """</span>
    <span class="n">tdim</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
    <span class="n">fdim</span> <span class="o">=</span> <span class="n">tdim</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">n_f</span> <span class="o">=</span> <span class="n">cell_num_entities</span><span class="p">(</span><span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">cell_type</span><span class="p">,</span> <span class="n">fdim</span><span class="p">)</span>
    <span class="n">n_c</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="n">tdim</span><span class="p">)</span><span class="o">.</span><span class="n">size_local</span>
    <span class="k">return</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.vstack.html#numpy.vstack" title="numpy.vstack"><span class="n">np</span><span class="o">.</span><span class="n">vstack</span></a><span class="p">((</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.repeat.html#numpy.repeat" title="numpy.repeat"><span class="n">np</span><span class="o">.</span><span class="n">repeat</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.arange.html#numpy.arange" title="numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="n">n_c</span><span class="p">),</span> <span class="n">n_f</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.tile.html#numpy.tile" title="numpy.tile"><span class="n">np</span><span class="o">.</span><span class="n">tile</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.arange.html#numpy.arange" title="numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="n">n_f</span><span class="p">),</span> <span class="n">n_c</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">u_e</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Exact solution."""</span>
    <span class="n">u_e</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tdim</span><span class="p">):</span>
        <span class="n">u_e</span> <span class="o">*=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.sin" title="ufl.sin"><span class="n">ufl</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">u_e</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.COMM_WORLD.html#mpi4py.MPI.COMM_WORLD" title="mpi4py.MPI.COMM_WORLD"><span class="n">comm</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.COMM_WORLD.html#mpi4py.MPI.COMM_WORLD" title="mpi4py.MPI.COMM_WORLD"><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span></a>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span>
<a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">dtype</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span></a>
</pre></div>
</div>
<p>Create the mesh</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># Number of elements in each direction</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.create_unit_cube" title="dolfinx.mesh.create_unit_cube"><span class="n">mesh</span><span class="o">.</span><span class="n">create_unit_cube</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://mpi4py.readthedocs.io/en/4.1.1/reference/mpi4py.MPI.COMM_WORLD.html#mpi4py.MPI.COMM_WORLD" title="mpi4py.MPI.COMM_WORLD"><span class="n">comm</span></a><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ghost_mode</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.cpp.mesh.html#dolfinx.cpp.mesh.GhostMode.none" title="dolfinx.cpp.mesh.GhostMode.none"><span class="n">mesh</span><span class="o">.</span><span class="n">GhostMode</span><span class="o">.</span><span class="n">none</span></a><span class="p">)</span>
</pre></div>
</div>
<p>We need to create a broken Lagrange space defined over the facets of
the mesh. To do so, we require a sub-mesh of the all facets. We begin
by creating a list of all of the facets in the mesh</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tdim</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
<span class="n">fdim</span> <span class="o">=</span> <span class="n">tdim</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">create_entities</span><span class="p">(</span><span class="n">fdim</span><span class="p">)</span>
<span class="n">facet_imap</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="n">fdim</span><span class="p">)</span>
<span class="n">num_facets</span> <span class="o">=</span> <span class="n">facet_imap</span><span class="o">.</span><span class="n">size_local</span> <span class="o">+</span> <span class="n">facet_imap</span><span class="o">.</span><span class="n">num_ghosts</span>
<span class="n">facets</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.arange.html#numpy.arange" title="numpy.arange"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="n">num_facets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.int32" title="numpy.int32"><span class="n">np</span><span class="o">.</span><span class="n">int32</span></a><span class="p">)</span>
</pre></div>
</div>
<p>The submesh is created with <a class="reference internal" href="../generated/dolfinx.mesh.html#dolfinx.mesh.create_submesh" title="dolfinx.mesh.create_submesh"><code class="xref py py-func docutils literal notranslate"><span class="pre">dolfinx.mesh.create_submesh()</span></code></a>,
which takes in the mesh to extract entities from, the topological
dimension of the entities, and the set of entities to create the
submesh (indices local to process).</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Despite all facets being present in the submesh, the entity map
isn’t necessarily the identity in parallel</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">facet_mesh</span><span class="p">,</span> <span class="n">facet_mesh_emap</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.create_submesh" title="dolfinx.mesh.create_submesh"><span class="n">mesh</span><span class="o">.</span><span class="n">create_submesh</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">,</span> <span class="n">fdim</span><span class="p">,</span> <span class="n">facets</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>Define function spaces</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Polynomial order</span>
<span class="n">V</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.functionspace" title="dolfinx.fem.functionspace"><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">,</span> <span class="p">(</span><span class="s2">"Discontinuous Lagrange"</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<span class="n">Vbar</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.functionspace" title="dolfinx.fem.functionspace"><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span></a><span class="p">(</span><span class="n">facet_mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">"Discontinuous Lagrange"</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</pre></div>
</div>
<p>Trial and test functions in mixed space, we use <code class="xref py py-class docutils literal notranslate"> <span class="pre">ufl.MixedFunctionSpace</span></code>
to create a single function space object we can extract <code class="xref py py-func docutils literal notranslate"> <span class="pre">ufl.TrialFunctions()</span></code>
and <a class="reference external" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.TestFunctions" title="(in Unified Form Language (UFL) v2025.2.0.post0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">ufl.TestFunctions()</span></code></a> from.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.functionspace.MixedFunctionSpace" title="ufl.functionspace.MixedFunctionSpace"><span class="n">W</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.functionspace.MixedFunctionSpace" title="ufl.functionspace.MixedFunctionSpace"><span class="n">ufl</span><span class="o">.</span><span class="n">MixedFunctionSpace</span></a><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">Vbar</span><span class="p">)</span>
<span class="n">u</span><span class="p">,</span> <span class="n">ubar</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.TrialFunctions" title="ufl.TrialFunctions"><span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunctions</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.functionspace.MixedFunctionSpace" title="ufl.functionspace.MixedFunctionSpace"><span class="n">W</span></a><span class="p">)</span>
<span class="n">v</span><span class="p">,</span> <span class="n">vbar</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.TestFunctions" title="ufl.TestFunctions"><span class="n">ufl</span><span class="o">.</span><span class="n">TestFunctions</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.functionspace.MixedFunctionSpace" title="ufl.functionspace.MixedFunctionSpace"><span class="n">W</span></a><span class="p">)</span>
</pre></div>
</div>
<section id="define-integration-measures">
<h2>Define integration measures<a class="headerlink" href="#define-integration-measures" title="Link to this heading"></a></h2>
<p>We define the integration measure over cells as we would do in any
other UFL form.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx_c</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span></a><span class="p">(</span><span class="s2">"dx"</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
</pre></div>
</div>
<p>For the cell boundaries, we need to define an integration measure to
integrate around the boundary of each cell. The integration entities
can be computed using the following convenience function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cell_boundary_facets</span> <span class="o">=</span> <span class="n">compute_cell_boundary_facets</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
<span class="n">cell_boundaries</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># A tag</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We pass the integration domains into the `ufl.Measure` through the</span>
<span class="c1"># `subdomain_data` keyword argument.</span>
<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ds_c</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span></a><span class="p">(</span><span class="s2">"ds"</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="p">[(</span><span class="n">cell_boundaries</span><span class="p">,</span> <span class="n">cell_boundary_facets</span><span class="p">)],</span> <span class="n">domain</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
</pre></div>
</div>
<p>Create a cell integral measure over the facet mesh</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx_f</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span></a><span class="p">(</span><span class="s2">"dx"</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">facet_mesh</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="variational-formulation">
<h2>Variational formulation<a class="headerlink" href="#variational-formulation" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.CellDiameter" title="ufl.geometry.CellDiameter"><span class="n">h</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.CellDiameter" title="ufl.geometry.CellDiameter"><span class="n">ufl</span><span class="o">.</span><span class="n">CellDiameter</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">n</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">ufl</span><span class="o">.</span><span class="n">FacetNormal</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">16.0</span> <span class="o">*</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.CellDiameter" title="ufl.geometry.CellDiameter"><span class="n">h</span></a>  <span class="c1"># Scaled penalty parameter</span>

<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.sin" title="ufl.sin"><span class="n">ufl</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x</span></a><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.sin" title="ufl.sin"><span class="n">ufl</span><span class="o">.</span><span class="n">sin</span></a><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x</span></a><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span>
    <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.grad" title="ufl.grad"><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">u</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.grad" title="ufl.grad"><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx_c</span></a>
    <span class="o">-</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">ubar</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.dot" title="ufl.dot"><span class="n">ufl</span><span class="o">.</span><span class="n">dot</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.grad" title="ufl.grad"><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">v</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">n</span></a><span class="p">))</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ds_c</span></a><span class="p">(</span><span class="n">cell_boundaries</span><span class="p">)</span>
    <span class="o">-</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.dot" title="ufl.dot"><span class="n">ufl</span><span class="o">.</span><span class="n">dot</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.grad" title="ufl.grad"><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">u</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.FacetNormal" title="ufl.geometry.FacetNormal"><span class="n">n</span></a><span class="p">),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">vbar</span><span class="p">))</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ds_c</span></a><span class="p">(</span><span class="n">cell_boundaries</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">ubar</span><span class="p">),</span> <span class="n">v</span> <span class="o">-</span> <span class="n">vbar</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">ds_c</span></a><span class="p">(</span><span class="n">cell_boundaries</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="o">-</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.div" title="ufl.div"><span class="n">ufl</span><span class="o">.</span><span class="n">div</span></a><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.grad" title="ufl.grad"><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">u_e</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x</span></a><span class="p">)))</span>  <span class="c1"># Manufacture a source term</span>
<span class="n">L</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx_c</span></a>
<span class="n">L</span> <span class="o">+=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.inner" title="ufl.inner"><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Constant" title="dolfinx.fem.function.Constant"><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span></a><span class="p">(</span><span class="n">facet_mesh</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">dtype</span></a><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="n">vbar</span><span class="p">)</span> <span class="o">*</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.measure.Measure" title="ufl.measure.Measure"><span class="n">dx_f</span></a>
</pre></div>
</div>
<p>Our bilinear form involves two domains (<code class="docutils literal notranslate"><span class="pre">msh</span></code> and <code class="docutils literal notranslate"><span class="pre">facet_mesh</span></code>). The
mesh passed to the measure is called the “integration domain”. For
each additional mesh in our form, we must pass an
<code class="xref py py-class docutils literal notranslate"><span class="pre">EntityMap&lt;dolfinx.mesh.EntityMap</span></code> object
that relates entities in that mesh to entities in the integration
domain. In this case, the only other mesh is <code class="docutils literal notranslate"><span class="pre">facet_mesh</span></code>, so we pass
<code class="docutils literal notranslate"><span class="pre">facet_mesh_emap</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">entity_maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">facet_mesh_emap</span><span class="p">]</span>
</pre></div>
</div>
<p>Compile forms for the blocked system, using <a class="reference external" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.extract_blocks" title="(in Unified Form Language (UFL) v2025.2.0.post0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">ufl.extract_blocks()</span></code></a>
for the bilinear and linear forms.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a_blocked</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.extract_blocks" title="ufl.extract_blocks"><span class="n">ufl</span><span class="o">.</span><span class="n">extract_blocks</span></a><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">entity_maps</span><span class="o">=</span><span class="n">entity_maps</span><span class="p">)</span>
<span class="n">L_blocked</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.form" title="dolfinx.fem.form"><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.extract_blocks" title="ufl.extract_blocks"><span class="n">ufl</span><span class="o">.</span><span class="n">extract_blocks</span></a><span class="p">(</span><span class="n">L</span><span class="p">))</span>
</pre></div>
</div>
<p>Apply Dirichlet boundary conditions. We begin by locating the boundary
facets of msh.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">msh_boundary_facets</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.exterior_facet_indices" title="dolfinx.mesh.exterior_facet_indices"><span class="n">mesh</span><span class="o">.</span><span class="n">exterior_facet_indices</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh.topology" title="dolfinx.mesh.Mesh.topology"><span class="n">msh</span><span class="o">.</span><span class="n">topology</span></a><span class="p">)</span>
</pre></div>
</div>
<p>Since the boundary condition is enforced in the facet space, we need
to get the corresponding facets in <code class="docutils literal notranslate"><span class="pre">facet_mesh</span></code> using the entity map</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">facet_mesh_boundary_facets</span> <span class="o">=</span> <span class="n">facet_mesh_emap</span><span class="o">.</span><span class="n">sub_topology_to_topology</span><span class="p">(</span>
    <span class="n">msh_boundary_facets</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Get the dofs and apply the boundary condition</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">facet_mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">create_connectivity</span><span class="p">(</span><span class="n">fdim</span><span class="p">,</span> <span class="n">fdim</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">dofs</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.locate_dofs_topological" title="dolfinx.fem.locate_dofs_topological"><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span></a><span class="p">(</span><span class="n">Vbar</span><span class="p">,</span> <span class="n">fdim</span><span class="p">,</span> <span class="n">facet_mesh_boundary_facets</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.DirichletBC" title="dolfinx.fem.bcs.DirichletBC"><span class="n">bc</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.dirichletbc" title="dolfinx.fem.dirichletbc"><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">dtype</span></a><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/2.2/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">dofs</span></a><span class="p">,</span> <span class="n">Vbar</span><span class="p">)</span>
</pre></div>
</div>
<p>Assemble the matrix and vector</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.assemble_matrix" title="dolfinx.fem.petsc.assemble_matrix"><span class="n">assemble_matrix</span></a><span class="p">(</span><span class="n">a_blocked</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="p">[</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.DirichletBC" title="dolfinx.fem.bcs.DirichletBC"><span class="n">bc</span></a><span class="p">])</span>
<span class="n">A</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">b</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.assemble_vector" title="dolfinx.fem.petsc.assemble_vector"><span class="n">assemble_vector</span></a><span class="p">(</span><span class="n">L_blocked</span><span class="p">)</span>
<span class="n">bcs1</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.bcs_by_block" title="dolfinx.fem.bcs_by_block"><span class="n">fem</span><span class="o">.</span><span class="n">bcs_by_block</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.extract_function_spaces" title="dolfinx.fem.extract_function_spaces"><span class="n">fem</span><span class="o">.</span><span class="n">extract_function_spaces</span></a><span class="p">(</span><span class="n">a_blocked</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.DirichletBC" title="dolfinx.fem.bcs.DirichletBC"><span class="n">bc</span></a><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.apply_lifting" title="dolfinx.fem.petsc.apply_lifting"><span class="n">apply_lifting</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">b</span></a><span class="p">,</span> <span class="n">a_blocked</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs1</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec.ghostUpdate" title="petsc4py.PETSc.Vec.ghostUpdate"><span class="n">b</span><span class="o">.</span><span class="n">ghostUpdate</span></a><span class="p">(</span><span class="n">addv</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.InsertMode.html#petsc4py.PETSc.InsertMode.ADD" title="petsc4py.PETSc.InsertMode.ADD"><span class="n">PETSc</span><span class="o">.</span><span class="n">InsertMode</span><span class="o">.</span><span class="n">ADD</span></a><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.ScatterMode.html#petsc4py.PETSc.ScatterMode.REVERSE" title="petsc4py.PETSc.ScatterMode.REVERSE"><span class="n">PETSc</span><span class="o">.</span><span class="n">ScatterMode</span><span class="o">.</span><span class="n">REVERSE</span></a><span class="p">)</span>
<span class="n">bcs0</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.bcs_by_block" title="dolfinx.fem.bcs_by_block"><span class="n">fem</span><span class="o">.</span><span class="n">bcs_by_block</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.extract_function_spaces" title="dolfinx.fem.extract_function_spaces"><span class="n">extract_function_spaces</span></a><span class="p">(</span><span class="n">L_blocked</span><span class="p">),</span> <span class="p">[</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.DirichletBC" title="dolfinx.fem.bcs.DirichletBC"><span class="n">bc</span></a><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.set_bc" title="dolfinx.fem.petsc.set_bc"><span class="n">set_bc</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">b</span></a><span class="p">,</span> <span class="n">bcs0</span><span class="p">)</span>
</pre></div>
</div>
<p>Setup the solver</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ksp</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.KSP.html#petsc4py.PETSc.KSP" title="petsc4py.PETSc.KSP"><span class="n">PETSc</span><span class="o">.</span><span class="n">KSP</span></a><span class="p">()</span><span class="o">.</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.KSP.html#petsc4py.PETSc.KSP.create" title="petsc4py.PETSc.KSP.create"><span class="n">create</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh.comm" title="dolfinx.mesh.Mesh.comm"><span class="n">msh</span><span class="o">.</span><span class="n">comm</span></a><span class="p">)</span>
<span class="n">ksp</span><span class="o">.</span><span class="n">setOperators</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">ksp</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">"preonly"</span><span class="p">)</span>
<span class="n">ksp</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">"lu"</span><span class="p">)</span>
<span class="n">ksp</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setFactorSolverType</span><span class="p">(</span><span class="s2">"superlu_dist"</span><span class="p">)</span>
</pre></div>
</div>
<p>Compute solution</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">x</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.create_vector" title="dolfinx.fem.petsc.create_vector"><span class="n">create_vector</span></a><span class="p">([</span><span class="n">V</span><span class="p">,</span> <span class="n">Vbar</span><span class="p">])</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">b</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">x</span></a><span class="p">)</span>
    <span class="n">ksp</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
    <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec.ghostUpdate" title="petsc4py.PETSc.Vec.ghostUpdate"><span class="n">x</span><span class="o">.</span><span class="n">ghostUpdate</span></a><span class="p">(</span><span class="n">addv</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.InsertMode.html#petsc4py.PETSc.InsertMode.INSERT" title="petsc4py.PETSc.InsertMode.INSERT"><span class="n">PETSc</span><span class="o">.</span><span class="n">InsertMode</span><span class="o">.</span><span class="n">INSERT</span></a><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.ScatterMode.html#petsc4py.PETSc.ScatterMode.FORWARD" title="petsc4py.PETSc.ScatterMode.FORWARD"><span class="n">PETSc</span><span class="o">.</span><span class="n">ScatterMode</span><span class="o">.</span><span class="n">FORWARD</span></a><span class="p">)</span>
    <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec.destroy" title="petsc4py.PETSc.Vec.destroy"><span class="n">b</span><span class="o">.</span><span class="n">destroy</span></a><span class="p">()</span>
<span class="k">except</span> <a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Error.html#petsc4py.PETSc.Error" title="petsc4py.PETSc.Error"><span class="n">PETSc</span><span class="o">.</span><span class="n">Error</span></a> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">ierr</span> <span class="o">==</span> <span class="mi">92</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"The required PETSc solver/preconditioner is not available. Exiting."</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
</pre></div>
</div>
<p>Create functions for the solution and update values</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="p">,</span> <span class="n">ubar</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"u"</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.html#dolfinx.fem.Function" title="dolfinx.fem.function.Function"><span class="n">fem</span><span class="o">.</span><span class="n">Function</span></a><span class="p">(</span><span class="n">Vbar</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">"ubar"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="../generated/dolfinx.fem.petsc.html#dolfinx.fem.petsc.assign" title="dolfinx.fem.petsc.assign"><span class="n">assign</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec" title="petsc4py.PETSc.Vec"><span class="n">x</span></a><span class="p">,</span> <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">ubar</span><span class="p">])</span>
<a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Vec.html#petsc4py.PETSc.Vec.destroy" title="petsc4py.PETSc.Vec.destroy"><span class="n">x</span><span class="o">.</span><span class="n">destroy</span></a><span class="p">()</span>
</pre></div>
</div>
<p>Write to file</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">has_adios2</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#module-dolfinx.io" title="dolfinx.io"><span class="nn">dolfinx.io</span></a><span class="w"> </span><span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#dolfinx.io.VTXWriter" title="dolfinx.io.utils.VTXWriter"><span class="n">VTXWriter</span></a>

    <span class="k">with</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#dolfinx.io.VTXWriter" title="dolfinx.io.utils.VTXWriter"><span class="n">VTXWriter</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh.comm" title="dolfinx.mesh.Mesh.comm"><span class="n">msh</span><span class="o">.</span><span class="n">comm</span></a><span class="p">,</span> <span class="s2">"u.bp"</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s2">"bp4"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">with</span> <a class="sphinx-codeautolink-a" href="../generated/dolfinx.io.html#dolfinx.io.VTXWriter" title="dolfinx.io.utils.VTXWriter"><span class="n">VTXWriter</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh.comm" title="dolfinx.mesh.Mesh.comm"><span class="n">msh</span><span class="o">.</span><span class="n">comm</span></a><span class="p">,</span> <span class="s2">"ubar.bp"</span><span class="p">,</span> <span class="n">ubar</span><span class="p">,</span> <span class="s2">"bp4"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"ADIOS2 required for VTX output"</span><span class="p">)</span>
</pre></div>
</div>
<p>Compute errors</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="../generated/dolfinx.mesh.html#dolfinx.mesh.Mesh" title="dolfinx.mesh.Mesh"><span class="n">msh</span></a><span class="p">)</span>
<span class="n">e_u</span> <span class="o">=</span> <span class="n">norm_L2</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x</span></a><span class="p">))</span>
<a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x_bar</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span></a><span class="p">(</span><span class="n">facet_mesh</span><span class="p">)</span>
<span class="n">e_ubar</span> <span class="o">=</span> <span class="n">norm_L2</span><span class="p">(</span><span class="n">ubar</span> <span class="o">-</span> <span class="n">u_e</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.fenicsproject.org/ufl/2025.2.0.post0/api-doc/ufl.html#ufl.geometry.SpatialCoordinate" title="ufl.geometry.SpatialCoordinate"><span class="n">x_bar</span></a><span class="p">))</span>
<a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Sys.html#petsc4py.PETSc.Sys.Print" title="petsc4py.PETSc.Sys.Print"><span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">Print</span></a><span class="p">(</span><span class="sa">f</span><span class="s2">"e_u = </span><span class="si">{</span><span class="n">e_u</span><span class="si">:</span><span class="s2">.5e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a class="sphinx-codeautolink-a" href="https://petsc.org/release/petsc4py/reference/petsc4py.PETSc.Sys.html#petsc4py.PETSc.Sys.Print" title="petsc4py.PETSc.Sys.Print"><span class="n">PETSc</span><span class="o">.</span><span class="n">Sys</span><span class="o">.</span><span class="n">Print</span></a><span class="p">(</span><span class="sa">f</span><span class="s2">"e_ubar = </span><span class="si">{</span><span class="n">e_ubar</span><span class="si">:</span><span class="s2">.5e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</div>
</div>
<footer><div aria-label="Footer" class="rst-footer-buttons" role="navigation">
<a accesskey="p" class="btn btn-neutral float-left" href="demo_pyamg.html" rel="prev" title="Solve the Poisson and linearised elasticity equations using pyamg"><span aria-hidden="true" class="fa fa-arrow-circle-left"></span> Previous</a>
<a accesskey="n" class="btn btn-neutral float-right" href="demo_mixed-topology.html" rel="next" title="Poisson equation">Next <span aria-hidden="true" class="fa fa-arrow-circle-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<p>© Copyright 2025, FEniCS Project.</p>
</div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
</div>
</div>
</section>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
</body>
</html>
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Electromagnetic scattering from a sphere (axisymmetric) &mdash; DOLFINx 0.7.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Mixed formulation for the Poisson equation" href="demo_mixed-poisson.html" />
    <link rel="prev" title="Electromagnetic modal analysis for a waveguide" href="demo_half_loaded_waveguide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            DOLFINx
          </a>
              <div class="version">
                0.7.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../demos.html">Demos</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../demos.html#pdes-introductory">PDEs (introductory)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_poisson.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_helmholtz.html">Helmholtz equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_scattering_boundary_conditions.html">Electromagnetic scattering from a wire with scattering boundary conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html">Electromagnetic scattering from a wire with perfectly matched layer condition</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_half_loaded_waveguide.html">Electromagnetic modal analysis for a waveguide</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Electromagnetic scattering from a sphere (axisymmetric)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#equations-problem-definition-and-implementation">Equations, problem definition and implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#problem-formulation">Problem formulation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#pdes-advanced">PDEs (advanced)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#nonlinear-problems">Nonlinear problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#mesh-generation">Mesh generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#interpolation-io-and-visualisation">Interpolation, IO and visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#advanced-iterative-solvers">Advanced iterative solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../demos.html#user-defined-and-advanced-finite-elements">User-defined and advanced finite elements</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../demos.html#list-of-all-demos">List of all demos</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_poisson.html">Poisson equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_biharmonic.html">Biharmonic equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_cahn-hilliard.html">Cahn-Hilliard equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_stokes.html">Stokes equations using Taylor-Hood elements</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_elasticity.html">Elasticity using algebraic multigrid</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_gmsh.html">Mesh generation with Gmsh</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_helmholtz.html">Helmholtz equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_static-condensation.html">Static condensation of linear elasticity</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pyvista.html">Visualization with PyVista</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_interpolation-io.html">Interpolation and IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_types.html">Solving PDEs with different scalar (float) types</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_tnt-elements.html">Creating TNT elements using Basix’s custom element interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_scattering_boundary_conditions.html">Electromagnetic scattering from a wire with scattering boundary conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_pml.html">Electromagnetic scattering from a wire with perfectly matched layer condition</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_half_loaded_waveguide.html">Electromagnetic modal analysis for a waveguide</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Electromagnetic scattering from a sphere (axisymmetric)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#equations-problem-definition-and-implementation">Equations, problem definition and implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#problem-formulation">Problem formulation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="demo_mixed-poisson.html">Mixed formulation for the Poisson equation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DOLFINx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../demos.html">Demos</a></li>
      <li class="breadcrumb-item active">Electromagnetic scattering from a sphere (axisymmetric)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/demos/demo_axis.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="electromagnetic-scattering-from-a-sphere-axisymmetric">
<h1>Electromagnetic scattering from a sphere (axisymmetric)<a class="headerlink" href="#electromagnetic-scattering-from-a-sphere-axisymmetric" title="Permalink to this heading"></a></h1>
<p>Copyright (C) 2022 Michele Castriotta, Igor Baratta, Jørgen S. Dokken</p>
<p>This demo is implemented in three files: one for the mesh generation
with gmsh, one for the calculation of analytical efficiencies, and one
for the variational forms and the solver. It illustrates how to:</p>
<ul class="simple">
<li><p>Setup and solve Maxwell’s equations for axisymmetric geometries</p></li>
<li><p>Implement (axisymmetric) perfectly matched layers</p></li>
</ul>
<section id="equations-problem-definition-and-implementation">
<h2>Equations, problem definition and implementation<a class="headerlink" href="#equations-problem-definition-and-implementation" title="Permalink to this heading"></a></h2>
<p>Import the modules that will be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mesh_sphere_axis</span> <span class="kn">import</span> <span class="n">generate_mesh_sphere_axis</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">jv</span><span class="p">,</span> <span class="n">jvp</span>

<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">dolfinx</span> <span class="kn">import</span> <span class="n">fem</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">plot</span>

<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dolfinx.io</span> <span class="kn">import</span> <span class="n">VTXWriter</span>
    <span class="n">has_vtx</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VTXWriter not available, solution won&#39;t be saved&quot;</span><span class="p">)</span>
    <span class="n">has_vtx</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gmsh</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This demo requires gmsh to be installed&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyvista</span>
    <span class="n">have_pyvista</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pyvista and pyvistaqt are required to visualise the solution&quot;</span><span class="p">)</span>
    <span class="n">have_pyvista</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>The time-harmonic Maxwell equation is complex-valued PDE. PETSc must
therefore have compiled with complex scalars.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Demo should only be executed with DOLFINx complex mode&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="problem-formulation">
<h2>Problem formulation<a class="headerlink" href="#problem-formulation" title="Permalink to this heading"></a></h2>
<p>Consider a metallic sphere embedded in a background medium (e.g., a
vacuum or water) subject to an incident plane wave, with the objective
to calculate the scattered electric field. We can simplify the problem
by considering the axisymmetric case. To verify this, let’s consider
the weak form of the problem with PML:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\int_{\Omega_m\cup\Omega_b}-(\nabla \times \mathbf{E}_s)
\cdot (\nabla \times \bar{\mathbf{v}})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}_s \cdot \bar{\mathbf{v}}+k_{0}^{2}\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}_b \cdot \bar{\mathbf{v}}~\mathrm{d} x\\
+\int_{\Omega_{pml}}\left[\boldsymbol{\mu}^{-1}_{pml} \nabla \times \mathbf{E}_s
\right]\cdot \nabla \times \bar{\mathbf{v}}-k_{0}^{2}
\left[\boldsymbol{\varepsilon}_{pml} \mathbf{E}_s \right]\cdot
\bar{\mathbf{v}}~ d x=0
\end{split}
\end{split}\]</div>
<p>Since we want to exploit axisymmetry of the problem, we can use
cylindrical coordinates as a more appropriate reference system:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\int_{\Omega_{cs}}\int_{0}^{2\pi}-(\nabla \times \mathbf{E}_s)
\cdot (\nabla \times \bar{\mathbf{v}})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}_s \cdot \bar{\mathbf{v}}+k_{0}^{2}\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}_b \cdot
\bar{\mathbf{v}}~ \rho d\rho dz d \phi\\
+\int_{\Omega_{cs}}
\int_{0}^{2\pi}\left[\boldsymbol{\mu}^{-1}_{pml} \nabla \times \mathbf{E}_s
\right]\cdot \nabla \times \bar{\mathbf{v}}-k_{0}^{2}
\left[\boldsymbol{\varepsilon}_{pml} \mathbf{E}_s \right]\cdot
\bar{\mathbf{v}}~ \rho d\rho dz d \phi=0
\end{split}
\end{split}\]</div>
<p>Expanding <span class="math notranslate nohighlight">\(\mathbf{E}_s\)</span>, <span class="math notranslate nohighlight">\(\mathbf{E}_b\)</span> and <span class="math notranslate nohighlight">\(\bar{\mathbf{v}}\)</span> in
cylindrical harmonics:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{E}_s(\rho, z, \phi) &amp;= \sum_m\mathbf{E}^{(m)}_s(\rho, z)e^{-jm\phi} \\
\mathbf{E}_b(\rho, z, \phi) &amp;= \sum_m\mathbf{E}^{(m)}_b(\rho, z)e^{-jm\phi} \\
\bar{\mathbf{v}}(\rho, z, \phi) &amp;=
\sum_m\bar{\mathbf{v}}^{(m)}(\rho, z)e^{+jm\phi}
\end{split}\]</div>
<p>The curl operator <span class="math notranslate nohighlight">\(\nabla\times\)</span> in cylindrical coordinates becomes:</p>
<div class="math notranslate nohighlight">
\[
\nabla \times \mathbf{a}=
\sum_{m}\left(\nabla \times \mathbf{a}^{(m)}\right) e^{-j m \phi}
\]</div>
<p>with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\left(\nabla \times \mathbf{a}^{(m)}\right) = \left[\hat{\rho}
\left(-\frac{\partial a_{\phi}^{(m)}}{\partial z}
-j\frac{m}{\rho} a_{z}^{(m)}\right)+\\ \hat{\phi}
\left(\frac{\partial a_{\rho}^{(m)}}{\partial z}
-\frac{\partial a_{z}^{(m)}}{\partial \rho}\right) \right.\\
\left.+\hat{z}\left(\frac{a_{\phi}^{(m)}}{\rho}
+\frac{\partial a_{\phi}^{(m)}}{\partial \rho}
+j \frac{m}{\rho} a_{\rho}^{(m)}\right)\right]
\end{split}
\end{split}\]</div>
<p>Assuming an axisymmetric permittivity <span class="math notranslate nohighlight">\(\varepsilon(\rho, z)\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\sum_{n, m}\int_{\Omega_{cs}} -(\nabla \times \mathbf{E}^{(m)}_s)
\cdot (\nabla \times \bar{\mathbf{v}}^{(m)})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}^{(m)}_s \cdot \bar{\mathbf{v}}^{(m)}+k_{0}^{2}
\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}^{(m)}_b \cdot \bar{\mathbf{v}}^{(m)}\\
+\left(\boldsymbol{\mu}^{-1}_{pml} \nabla \times \mathbf{E}^{(m)}_s
\right)\cdot \nabla \times \bar{\mathbf{v}}^{(m)}-k_{0}^{2}
\left(\boldsymbol{\varepsilon}_{pml} \mathbf{E}^{(m)}_s \right)\cdot
\bar{\mathbf{v}}^{(m)}~ \rho d\rho dz \int_{0}^{2 \pi} e^{-i(m-n) \phi}
d \phi=0
\end{split}\]</div>
<p>For the last integral, we have that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\int_{0}^{2 \pi} e^{-i(m-n) \phi}d \phi=
\begin{cases}
2\pi &amp;\textrm{if } m=n\\
0    &amp;\textrm{if }m\neq n
\end{cases}
\end{split}\]</div>
<p>We can therefore consider only the case <span class="math notranslate nohighlight">\(m = n\)</span> and simplify the
summation in the following way:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\sum_{m}\int_{\Omega_{cs}}-(\nabla \times \mathbf{E}^{(m)}_s)
\cdot (\nabla \times \bar{\mathbf{v}}^{(m)})+\varepsilon_{r} k_{0}^{2}
\mathbf{E}^{(m)}_s \cdot \bar{\mathbf{v}}^{(m)}
+k_{0}^{2}\left(\varepsilon_{r}
-\varepsilon_b\right)\mathbf{E}^{(m)}_b \cdot \bar{\mathbf{v}}^{(m)}\\
+\left(\boldsymbol{\mu}^{-1}_{pml} \nabla \times \mathbf{E}^{(m)}_s
\right)\cdot \nabla \times \bar{\mathbf{v}}^{(m)}-k_{0}^{2}
\left(\boldsymbol{\varepsilon}_{pml} \mathbf{E}^{(m)}_s \right)\cdot
\bar{\mathbf{v}}^{(m)}~ \rho d\rho dz =0
\end{split}
\end{split}\]</div>
<p>What we have just obtained are multiple weak forms corresponding to
different cylindrical harmonics propagating independently. Let’s now
solve it in DOLFINx. As a first step we can define the function for
the <span class="math notranslate nohighlight">\(\nabla\times\)</span> operator in cylindrical coordinates:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">curl_axis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="n">curl_r</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">curl_z</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">curl_p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">((</span><span class="n">curl_r</span><span class="p">,</span> <span class="n">curl_z</span><span class="p">,</span> <span class="n">curl_p</span><span class="p">))</span>
</pre></div>
</div>
<p>Then we need to define the analytical formula for the background
field. We will consider a TMz polarized plane wave, that is a plane
wave with the magnetic field normal to our reference plane</p>
<p>For a TMz polarization, we can write the cylindrical harmonics
<span class="math notranslate nohighlight">\(\mathbf{E}^{(m)}_b\)</span> of the background field in this way (<a class="reference external" href="https://doi.org/10.1139/p55-024">Wait
1955</a>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
\mathbf{E}^{(m)}_b = \hat{\rho} \left(E_{0} \cos \theta
e^{j k z \cos \theta} j^{-m+1} J_{m}^{\prime}\left(k_{0} \rho \sin
\theta\right)\right)
+\hat{z} \left(E_{0} \sin \theta e^{j k z \cos \theta}j^{-m} J_{m}
\left(k \rho \sin \theta\right)\right)\\
+\hat{\phi} \left(\frac{E_{0} \cos \theta}{k \rho \sin \theta}
e^{j k z \cos \theta} mj^{-m} J_{m}\left(k \rho \sin \theta\right)\right)
\end{split}
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(k = 2\pi n_b/\lambda = k_0n_b\)</span> being the wavevector, <span class="math notranslate nohighlight">\(\theta\)</span>
being the angle between <span class="math notranslate nohighlight">\(\mathbf{E}_b\)</span> and <span class="math notranslate nohighlight">\(\hat{\rho}\)</span>, and <span class="math notranslate nohighlight">\(J_m\)</span>
representing the <span class="math notranslate nohighlight">\(m\)</span>-th order Bessel function of first kind and
<span class="math notranslate nohighlight">\(J_{m}^{\prime}\)</span> its derivative. We implement these functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">background_field_rz</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">k0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">n_bkg</span>
    <span class="n">a_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
           <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jvp</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">a_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
           <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**-</span><span class="n">m</span> <span class="o">*</span> <span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a_r</span><span class="p">,</span> <span class="n">a_z</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">background_field_p</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">k0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">n_bkg</span>
    <span class="n">a_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
           <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">*</span> <span class="n">m</span>
           <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">jv</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">a_p</span>
</pre></div>
</div>
<p>PML can be implemented in a spherical shell surrounding the background
domain. We can use the following complex coordinate transformation for
PML:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
&amp;\rho^{\prime} = \rho\left[1 +j \alpha/k_0 \left(\frac{r
- r_{dom}}{r~r_{pml}}\right)\right] \\
&amp;z^{\prime} = z\left[1 +j \alpha/k_0 \left(\frac{r
- r_{dom}}{r~r_{pml}}\right)\right] \\
&amp;\phi^{\prime} = \phi
\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(\alpha\)</span> tuning the absorption inside the PML, and <span class="math notranslate nohighlight">\(r =
\sqrt{\rho^2 + z^2}\)</span>. This coordinate transformation has the following
Jacobian:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{J}=\mathbf{A}^{-1}= \nabla\boldsymbol{\rho}^
\prime(\boldsymbol{\rho}) =
\left[\begin{array}{ccc}
\frac{\partial \rho^{\prime}}{\partial \rho} &amp;
\frac{\partial z^{\prime}}{\partial \rho} &amp;
0 \\
\frac{\partial \rho^{\prime}}{\partial z} &amp;
\frac{\partial z^{\prime}}{\partial z} &amp;
0 \\
0 &amp;
0 &amp;
\frac{\rho^\prime}{\rho}\frac{\partial \phi^{\prime}}{\partial \phi}
\end{array}\right]=\left[\begin{array}{ccc}
J_{11} &amp; J_{12} &amp; 0 \\
J_{21} &amp; J_{22} &amp; 0 \\
0 &amp; 0 &amp; J_{33}
\end{array}\right]
\end{split}\]</div>
<p>which we can use to calculate <span class="math notranslate nohighlight">\({\boldsymbol{\varepsilon}_{pml}}\)</span> and
<span class="math notranslate nohighlight">\({\boldsymbol{\mu}_{pml}}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
&amp; {\boldsymbol{\varepsilon}_{pml}} =
A^{-1} \mathbf{A} {\boldsymbol{\varepsilon}_b}\mathbf{A}^{T}\\
&amp; {\boldsymbol{\mu}_{pml}} =
A^{-1} \mathbf{A} {\boldsymbol{\mu}_b}\mathbf{A}^{T}
\end{split}\]</div>
<p>For doing these calculations, we define the <code class="docutils literal notranslate"><span class="pre">pml_coordinate</span></code> and
<code class="docutils literal notranslate"><span class="pre">create_mu_eps</span></code> functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>

<span class="k">def</span> <span class="nf">pml_coordinate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">k0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">radius_dom</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">radius_pml</span> <span class="o">*</span> <span class="n">r</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_eps_mu</span><span class="p">(</span><span class="n">pml</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">eps_bkg</span><span class="p">,</span> <span class="n">mu_bkg</span><span class="p">):</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">pml</span><span class="p">)</span>

    <span class="c1"># Transform the 2x2 Jacobian into a 3x3 matrix.</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">(((</span><span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">J</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                       <span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">J</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                       <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span><span class="p">)))</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
    <span class="n">eps_pml</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">eps_bkg</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">mu_pml</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">mu_bkg</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eps_pml</span><span class="p">,</span> <span class="n">mu_pml</span>
</pre></div>
</div>
<p>We can now define some constants and geometrical parameters, and then
we can generate the mesh with Gmsh, by using the function
<code class="docutils literal notranslate"><span class="pre">generate_mesh_sphere_axis</span></code> in <code class="docutils literal notranslate"><span class="pre">mesh_sphere_axis.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constants</span>
<span class="n">epsilon_0</span> <span class="o">=</span> <span class="mf">8.8541878128</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">12</span>  <span class="c1"># Vacuum permittivity</span>
<span class="n">mu_0</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span>  <span class="c1"># Vacuum permeability</span>
<span class="n">Z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu_0</span> <span class="o">/</span> <span class="n">epsilon_0</span><span class="p">)</span>  <span class="c1"># Vacuum impedance</span>

<span class="c1"># Radius of the sphere</span>
<span class="n">radius_sph</span> <span class="o">=</span> <span class="mf">0.025</span>

<span class="c1"># Radius of the domain</span>
<span class="n">radius_dom</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Radius of the boundary where scattering efficiency is calculated</span>
<span class="n">radius_scatt</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">radius_dom</span>

<span class="c1"># Radius of the PML shell</span>
<span class="n">radius_pml</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># Mesh sizes</span>
<span class="n">mesh_factor</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">in_sph_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">2.0e-3</span>
<span class="n">on_sph_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">2.0e-3</span>
<span class="n">scatt_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">60.0e-3</span>
<span class="n">pml_size</span> <span class="o">=</span> <span class="n">mesh_factor</span> <span class="o">*</span> <span class="mf">40.0e-3</span>

<span class="c1"># Tags for the subdomains</span>
<span class="n">au_tag</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">bkg_tag</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">pml_tag</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">scatt_tag</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Mesh generation</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">generate_mesh_sphere_axis</span><span class="p">(</span>
        <span class="n">radius_sph</span><span class="p">,</span> <span class="n">radius_scatt</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">,</span>
        <span class="n">in_sph_size</span><span class="p">,</span> <span class="n">on_sph_size</span><span class="p">,</span> <span class="n">scatt_size</span><span class="p">,</span> <span class="n">pml_size</span><span class="p">,</span>
        <span class="n">au_tag</span><span class="p">,</span> <span class="n">bkg_tag</span><span class="p">,</span> <span class="n">pml_tag</span><span class="p">,</span> <span class="n">scatt_tag</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">msh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
</pre></div>
</div>
<p>Visually check of the mesh and of the subdomains using PyVista:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">have_pyvista</span><span class="p">:</span>
    <span class="n">topology</span><span class="p">,</span> <span class="n">cell_types</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">msh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">cell_types</span><span class="p">,</span> <span class="n">geometry</span><span class="p">)</span>
    <span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
    <span class="n">num_local_cells</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span><span class="o">.</span><span class="n">size_local</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">indices</span> <span class="o">&lt;</span> <span class="n">num_local_cells</span><span class="p">]</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">OFF_SCREEN</span><span class="p">:</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pyvista</span><span class="o">.</span><span class="n">start_xvfb</span><span class="p">()</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="s2">&quot;sphere_axis_mesh.png&quot;</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">])</span>
</pre></div>
</div>
<p>For the <span class="math notranslate nohighlight">\(\hat{\rho}\)</span> and <span class="math notranslate nohighlight">\(\hat{z}\)</span> components of the electric field,
we will use Nedelec elements, while for the <span class="math notranslate nohighlight">\(\hat{\phi}\)</span> components we
will use Lagrange elements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">degree</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">curl_el</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;N1curl&quot;</span><span class="p">,</span> <span class="n">msh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">degree</span><span class="p">)</span>
<span class="n">lagr_el</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="n">msh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">degree</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">msh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">MixedElement</span><span class="p">([</span><span class="n">curl_el</span><span class="p">,</span> <span class="n">lagr_el</span><span class="p">]))</span>
</pre></div>
</div>
<p>The integration domains of our problem are the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Measures for subdomains</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">msh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="n">cell_tags</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;quadrature_degree&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="n">dDom</span> <span class="o">=</span> <span class="n">dx</span><span class="p">((</span><span class="n">au_tag</span><span class="p">,</span> <span class="n">bkg_tag</span><span class="p">))</span>
<span class="n">dPml</span> <span class="o">=</span> <span class="n">dx</span><span class="p">(</span><span class="n">pml_tag</span><span class="p">)</span>
</pre></div>
</div>
<p>The <span class="math notranslate nohighlight">\(\varepsilon_r\)</span> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_bkg</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Background refractive index</span>
<span class="n">eps_bkg</span> <span class="o">=</span> <span class="n">n_bkg</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Background relative permittivity</span>
<span class="n">eps_au</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0782</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">5.8089</span>

<span class="n">D</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">msh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<span class="n">au_cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">au_tag</span><span class="p">)</span>
<span class="n">bkg_cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">bkg_tag</span><span class="p">)</span>
<span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">au_cells</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">au_cells</span><span class="p">,</span> <span class="n">eps_au</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
<span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">bkg_cells</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">bkg_cells</span><span class="p">,</span> <span class="n">eps_bkg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
<span class="n">eps</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">scatter_forward</span><span class="p">()</span>
</pre></div>
</div>
<p>For the background field, we need to specify the wavelength (and the
wavevector), angle of incidence, harmonic numbers and the intensity:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wl0</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># Wavelength of the background field</span>
<span class="n">k0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wl0</span>  <span class="c1"># Wavevector of the background field</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>  <span class="c1"># Angle of incidence of the background field</span>
<span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># list of harmonics</span>
<span class="n">I0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">n_bkg</span> <span class="o">/</span> <span class="n">Z0</span>  <span class="c1"># Intensity</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">m_list</span></code> contains the harmonic numbers we want to solve for. In
general, we would need to solve for <span class="math notranslate nohighlight">\(m\in \mathbb{Z}\)</span>. However, for
sub-wavelength structure (as our sphere), we can limit the calculation
to few harmonic numbers, e.g., <span class="math notranslate nohighlight">\(m = -1, 0, 1\)</span>. Besides, we have that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
&amp;J_{-m}=(-1)^m J_m \\
&amp;J_{-m}^{\prime}=(-1)^m J_m^{\prime} \\
&amp;j^{-m}=(-1)^m j^m
\end{split}\]</div>
<p>and therefore:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
&amp;E_{b, \rho}^{(m)}=E_{b, \rho}^{(-m)} \\
&amp;E_{b, \phi}^{(m)}=-E_{b, \phi}^{(-m)} \\
&amp;E_{b, z}^{(m)}=E_{b, z}^{(-m)}
\end{split}\]</div>
<p>In light of this, we can solve the problem for <span class="math notranslate nohighlight">\(m\geq 0\)</span>.</p>
<p>We now now define <code class="docutils literal notranslate"><span class="pre">eps_pml</span></code> and <code class="docutils literal notranslate"><span class="pre">mu_pml</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rho</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">msh</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">pml_coords</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">((</span><span class="n">pml_coordinate</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">),</span>
                            <span class="n">pml_coordinate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">radius_dom</span><span class="p">,</span> <span class="n">radius_pml</span><span class="p">)))</span>

<span class="n">eps_pml</span><span class="p">,</span> <span class="n">mu_pml</span> <span class="o">=</span> <span class="n">create_eps_mu</span><span class="p">(</span><span class="n">pml_coords</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">eps_bkg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Define other objects that will be used inside our solver loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Total field</span>
<span class="n">Eh_m</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Esh</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FacetNormal</span><span class="p">(</span><span class="n">msh</span><span class="p">)</span>
<span class="n">n_3d</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># Geometrical cross section of the sphere, for efficiency calculation</span>
<span class="n">gcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius_sph</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Marker functions for the scattering efficiency integral</span>
<span class="n">marker</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
<span class="n">scatt_facets</span> <span class="o">=</span> <span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)</span>
<span class="n">incident_cells</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">compute_incident_entities</span><span class="p">(</span><span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">scatt_facets</span><span class="p">,</span>
                                                <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
<span class="n">midpoints</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">compute_midpoints</span><span class="p">(</span><span class="n">msh</span><span class="p">,</span> <span class="n">msh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">incident_cells</span><span class="p">)</span>
<span class="n">inner_cells</span> <span class="o">=</span> <span class="n">incident_cells</span><span class="p">[(</span><span class="n">midpoints</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">midpoints</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">radius_scatt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
<span class="n">marker</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">inner_cells</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Define integration domain for the gold sphere</span>
<span class="n">dAu</span> <span class="o">=</span> <span class="n">dx</span><span class="p">(</span><span class="n">au_tag</span><span class="p">)</span>

<span class="c1"># Define integration facet for the scattering efficiency</span>
<span class="n">dS</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dS&quot;</span><span class="p">,</span> <span class="n">msh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="n">facet_tags</span><span class="p">)</span>
</pre></div>
</div>
<p>We also specify a variable <code class="docutils literal notranslate"><span class="pre">phi</span></code>, corresponding to the <span class="math notranslate nohighlight">\(\phi\)</span> angle of
the cylindrical coordinate system that we will use to post-process the
field and save it along the plane at <span class="math notranslate nohighlight">\(\phi = \pi/4\)</span>. In particular,
the scattered field needs to be transformed for <span class="math notranslate nohighlight">\(m\neq 0\)</span> in the
following way:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
&amp;E_{s, \rho}^{(m)}(\phi)=E_{s, \rho}^{(m)}(e^{-jm\phi}+e^{jm\phi}) \\
&amp;E_{s, \phi}^{(m)}(\phi)=E_{s, \phi}^{(m)}(e^{-jm\phi}-e^{jm\phi}) \\
&amp;E_{s, z}^{(m)}(\phi)=E_{s, z}^{(m)}(e^{-jm\phi}+e^{jm\phi})
\end{split}\]</div>
<p>For this reason, we also add a <code class="docutils literal notranslate"><span class="pre">phase</span></code> constant for the above phase
term:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>

<span class="c1"># Initialize phase term</span>
<span class="n">phase</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">msh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)))</span>
</pre></div>
</div>
<p>We now solve the problem:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">m_list</span><span class="p">:</span>
    <span class="c1"># Definition of Trial and Test functions</span>
    <span class="n">Es_m</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">v_m</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="c1"># Background field</span>
    <span class="n">Eb_m</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">f_rz</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">background_field_rz</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">f_p</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">background_field_p</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n_bkg</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">Eb_m</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">f_rz</span><span class="p">)</span>
    <span class="n">Eb_m</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">f_p</span><span class="p">)</span>

    <span class="n">curl_Es_m</span> <span class="o">=</span> <span class="n">curl_axis</span><span class="p">(</span><span class="n">Es_m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
    <span class="n">curl_v_m</span> <span class="o">=</span> <span class="n">curl_axis</span><span class="p">(</span><span class="n">v_m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="o">-</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">curl_Es_m</span><span class="p">,</span> <span class="n">curl_v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dDom</span> \
        <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Es_m</span><span class="p">,</span> <span class="n">v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dDom</span> \
        <span class="o">+</span> <span class="n">k0</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">eps</span> <span class="o">-</span> <span class="n">eps_bkg</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Eb_m</span><span class="p">,</span> <span class="n">v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dDom</span> \
        <span class="o">-</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mu_pml</span><span class="p">)</span> <span class="o">*</span> <span class="n">curl_Es_m</span><span class="p">,</span> <span class="n">curl_v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dPml</span> \
        <span class="o">+</span> <span class="n">k0</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">eps_pml</span> <span class="o">*</span> <span class="n">Es_m</span><span class="p">,</span> <span class="n">v_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dPml</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">lhs</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">rhs</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

    <span class="n">problem</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="p">[],</span> <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> <span class="s2">&quot;pc_type&quot;</span><span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">})</span>
    <span class="n">Esh_m</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

    <span class="c1"># Scattered magnetic field</span>
    <span class="n">Hsh_m</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">curl_axis</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Z0</span> <span class="o">*</span> <span class="n">k0</span><span class="p">)</span>

    <span class="c1"># Total electric field</span>
    <span class="n">Eh_m</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Eb_m</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">Esh_m</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span>
</pre></div>
</div>
<p>We can add our solution to the total scattered field, which also
includes the transformation to the <span class="math notranslate nohighlight">\(\phi\)</span> plane:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">phase</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span>
    <span class="n">rotate_to_phi</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">((</span><span class="n">phase</span> <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">phase</span><span class="p">),</span>
                                   <span class="n">phase</span> <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">phase</span><span class="p">),</span>
                                   <span class="n">phase</span> <span class="o">-</span> <span class="n">ufl</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">phase</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># initialize and do not transform</span>
        <span class="n">Esh</span> <span class="o">=</span> <span class="n">Esh_m</span>
    <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># initialize and transform</span>
        <span class="n">Esh</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">elem_mult</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">rotate_to_phi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># transform</span>
        <span class="n">Esh</span> <span class="o">+=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">elem_mult</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">rotate_to_phi</span><span class="p">)</span>
</pre></div>
</div>
<p>To check that  our calculations are correct, we can use as reference
quantities the absorption and scattering efficiencies:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Efficiencies calculation</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># initialize and do not add 2 factor</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="o">-</span><span class="n">ufl</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Hsh_m</span><span class="p">)),</span> <span class="n">n_3d</span><span class="p">)</span> <span class="o">*</span> <span class="n">marker</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">eps_au</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Eh_m</span><span class="p">,</span> <span class="n">Eh_m</span><span class="p">))</span> <span class="o">/</span> <span class="n">Z0</span>
        <span class="n">q_abs_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dAu</span><span class="p">))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_sca_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">((</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dS</span><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_abs_fenics</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_abs_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
        <span class="n">q_sca_fenics</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_sca_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># initialize and add 2 factor</span>
        <span class="n">P</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="o">-</span><span class="n">ufl</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Hsh_m</span><span class="p">)),</span> <span class="n">n_3d</span><span class="p">)</span> <span class="o">*</span> <span class="n">marker</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">eps_au</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Eh_m</span><span class="p">,</span> <span class="n">Eh_m</span><span class="p">))</span> <span class="o">/</span> <span class="n">Z0</span> <span class="o">/</span> <span class="n">n_bkg</span>
        <span class="n">q_abs_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dAu</span><span class="p">))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_sca_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">((</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dS</span><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_abs_fenics</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_abs_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
        <span class="n">q_sca_fenics</span> <span class="o">=</span> <span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_sca_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># do not initialize and add 2 factor</span>
        <span class="n">P</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="o">-</span><span class="n">ufl</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Esh_m</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Hsh_m</span><span class="p">)),</span> <span class="n">n_3d</span><span class="p">)</span> <span class="o">*</span> <span class="n">marker</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">eps_au</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Eh_m</span><span class="p">,</span> <span class="n">Eh_m</span><span class="p">))</span> <span class="o">/</span> <span class="n">Z0</span> <span class="o">/</span> <span class="n">n_bkg</span>
        <span class="n">q_abs_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dAu</span><span class="p">))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_sca_fenics_proc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">((</span><span class="n">P</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">dS</span><span class="p">(</span><span class="n">scatt_tag</span><span class="p">)))</span> <span class="o">/</span> <span class="n">gcs</span> <span class="o">/</span> <span class="n">I0</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">q_abs_fenics</span> <span class="o">+=</span> <span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_abs_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
        <span class="n">q_sca_fenics</span> <span class="o">+=</span> <span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">q_sca_fenics_proc</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>

<span class="n">q_ext_fenics</span> <span class="o">=</span> <span class="n">q_abs_fenics</span> <span class="o">+</span> <span class="n">q_sca_fenics</span>
</pre></div>
</div>
<p>The quantities <code class="docutils literal notranslate"><span class="pre">P</span></code> and <code class="docutils literal notranslate"><span class="pre">Q</span></code> have an additional <code class="docutils literal notranslate"><span class="pre">2</span></code> factor for <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">!=</span> <span class="pre">0</span></code>
due to parity.</p>
<p>We now compare the numerical and analytical efficiencies (he latter
were obtained with the following routine provided by the
<a class="reference external" href="https://github.com/ovidiopr/scattnlay"><code class="docutils literal notranslate"><span class="pre">scattnlay</span></code></a> library):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scattnlay</span> <span class="kn">import</span> <span class="n">scattnlay</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eps_au</span><span class="p">)</span><span class="o">/</span><span class="n">n_bkg</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">radius_sph</span><span class="o">/</span><span class="n">wl0</span><span class="o">*</span><span class="n">n_bkg</span>

<span class="n">q_sca_analyt</span><span class="p">,</span> <span class="n">q_abs_analyt</span> <span class="o">=</span> <span class="n">scattnlay</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">))[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
<p>The numerical values are reported here below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q_abs_analyt</span> <span class="o">=</span> <span class="mf">0.9622728008329892</span>
<span class="n">q_sca_analyt</span> <span class="o">=</span> <span class="mf">0.07770397394691526</span>
<span class="n">q_ext_analyt</span> <span class="o">=</span> <span class="n">q_abs_analyt</span> <span class="o">+</span> <span class="n">q_sca_analyt</span>
</pre></div>
</div>
<p>Finally, we can calculate the error and save our total scattered
field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Error calculation</span>
<span class="n">err_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_abs_analyt</span> <span class="o">-</span> <span class="n">q_abs_fenics</span><span class="p">)</span> <span class="o">/</span> <span class="n">q_abs_analyt</span>
<span class="n">err_sca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_sca_analyt</span> <span class="o">-</span> <span class="n">q_sca_fenics</span><span class="p">)</span> <span class="o">/</span> <span class="n">q_sca_analyt</span>
<span class="n">err_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q_ext_analyt</span> <span class="o">-</span> <span class="n">q_ext_fenics</span><span class="p">)</span> <span class="o">/</span> <span class="n">q_ext_analyt</span>

<span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The analytical absorption efficiency is </span><span class="si">{</span><span class="n">q_abs_analyt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The numerical absorption efficiency is </span><span class="si">{</span><span class="n">q_abs_fenics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error is </span><span class="si">{</span><span class="n">err_abs</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The analytical scattering efficiency is </span><span class="si">{</span><span class="n">q_sca_analyt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The numerical scattering efficiency is </span><span class="si">{</span><span class="n">q_sca_fenics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error is </span><span class="si">{</span><span class="n">err_sca</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The analytical extinction efficiency is </span><span class="si">{</span><span class="n">q_ext_analyt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The numerical extinction efficiency is </span><span class="si">{</span><span class="n">q_ext_fenics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The error is </span><span class="si">{</span><span class="n">err_ext</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Check whether the geometrical and optical parameters ar correct</span>
<span class="k">assert</span> <span class="n">radius_sph</span> <span class="o">/</span> <span class="n">wl0</span> <span class="o">==</span> <span class="mf">0.025</span> <span class="o">/</span> <span class="mf">0.4</span>
<span class="k">assert</span> <span class="n">eps_au</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0782</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">5.8089</span>
<span class="k">assert</span> <span class="n">err_abs</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
<span class="c1"># assert err_sca &lt; 0.01</span>
<span class="k">assert</span> <span class="n">err_ext</span> <span class="o">&lt;</span> <span class="mf">0.01</span>

<span class="k">if</span> <span class="n">has_vtx</span><span class="p">:</span>
    <span class="n">v_dg_el</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">msh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">degree</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">msh</span><span class="p">,</span> <span class="n">v_dg_el</span><span class="p">)</span>
    <span class="n">Es_dg</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
    <span class="n">Es_expr</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">Esh</span><span class="p">,</span> <span class="n">W</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">interpolation_points</span><span class="p">())</span>
    <span class="n">Es_dg</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">Es_expr</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">VTXWriter</span><span class="p">(</span><span class="n">msh</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="s2">&quot;sols/Es.bp&quot;</span><span class="p">,</span> <span class="n">Es_dg</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_half_loaded_waveguide.html" class="btn btn-neutral float-left" title="Electromagnetic modal analysis for a waveguide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="demo_mixed-poisson.html" class="btn btn-neutral float-right" title="Mixed formulation for the Poisson equation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, FEniCS Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>